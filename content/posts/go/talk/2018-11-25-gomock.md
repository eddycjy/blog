---

title:      "ä½¿ç”¨ Gomock è¿›è¡Œå•å…ƒæµ‹è¯•"
date:       2018-11-25 12:00:00
author:     "ç…é±¼"
toc: true
tags:
    - go
---

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œéœ€è¦è¿›è¡Œå•å…ƒæµ‹è¯•çš„æ—¶å€™ã€‚å´å¾€å¾€å‘ç°æœ‰ä¸€å¤§å †ä¾èµ–é¡¹ã€‚è¿™æ—¶å€™å°±æ˜¯ [Gomock](https://github.com/golang/mock) å¤§æ˜¾èº«æ‰‹çš„æ—¶å€™äº†

Gomock æ˜¯ Go è¯­è¨€çš„ä¸€ä¸ª mock æ¡†æ¶ï¼Œå®˜æ–¹çš„é‚£ç§ ğŸ¤ª

## å®‰è£…

```
$ go get -u github.com/golang/mock/gomock
$ go install github.com/golang/mock/mockgen
```

1. ç¬¬ä¸€æ­¥ï¼šæˆ‘ä»¬å°†å®‰è£… gomock ç¬¬ä¸‰æ–¹åº“å’Œ mock ä»£ç çš„ç”Ÿæˆå·¥å…· mockgenã€‚è€Œåè€…å¯ä»¥å¤§å¤§çš„èŠ‚çœæˆ‘ä»¬çš„å·¥ä½œé‡ã€‚åªéœ€è¦äº†è§£å…¶ä½¿ç”¨æ–¹å¼å°±å¯ä»¥

2. ç¬¬äºŒæ­¥ï¼šè¾“å…¥ `mockgen` éªŒè¯ä»£ç ç”Ÿæˆå·¥å…·æ˜¯å¦å®‰è£…æ­£ç¡®ã€‚è‹¥æ— æ³•æ­£å¸¸å“åº”ï¼Œè¯·æ£€æŸ¥ `bin` ç›®å½•ä¸‹æ˜¯å¦åŒ…å«è¯¥äºŒè¿›åˆ¶æ–‡ä»¶

### ç”¨æ³•

åœ¨ `mockgen` å‘½ä»¤ä¸­ï¼Œæ”¯æŒä¸¤ç§ç”Ÿæˆæ¨¡å¼ï¼š

1. sourceï¼šä»æºæ–‡ä»¶ç”Ÿæˆ mock æ¥å£ï¼ˆé€šè¿‡ -source å¯ç”¨ï¼‰

```
mockgen -source=foo.go [other options]
```

2. reflectï¼šé€šè¿‡ä½¿ç”¨åå°„ç¨‹åºæ¥ç”Ÿæˆ mock æ¥å£ã€‚å®ƒé€šè¿‡ä¼ é€’ä¸¤ä¸ªéæ ‡å¿—å‚æ•°æ¥å¯ç”¨ï¼šå¯¼å…¥è·¯å¾„å’Œé€—å·åˆ†éš”çš„æ¥å£åˆ—è¡¨

```
mockgen database/sql/driver Conn,Driver
```

ä»æœ¬è´¨ä¸Šæ¥è®²ï¼Œä¸¤ç§æ–¹å¼ç”Ÿæˆçš„ mock ä»£ç å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚å› æ­¤é€‰æ‹©åˆé€‚çš„å°±å¯ä»¥äº†

## å†™æµ‹è¯•ç”¨ä¾‹

åœ¨æœ¬æ–‡å°†æ¨¡æ‹Ÿä¸€ä¸ªç®€å• Demo æ¥ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œç†Ÿæ‚‰æ•´ä½“çš„æµ‹è¯•æµç¨‹

### æ­¥éª¤

1. æƒ³æ¸…æ¥šæ•´ä½“é€»è¾‘
2. å®šä¹‰æƒ³è¦ï¼ˆæ¨¡æ‹Ÿï¼‰ä¾èµ–é¡¹çš„ interfaceï¼ˆæ¥å£ï¼‰
3. ä½¿ç”¨ `mockgen` å‘½ä»¤å¯¹æ‰€éœ€ mock çš„ interface ç”Ÿæˆ mock æ–‡ä»¶
4. ç¼–å†™å•å…ƒæµ‹è¯•çš„é€»è¾‘ï¼Œåœ¨æµ‹è¯•ä¸­ä½¿ç”¨ mock
5. è¿›è¡Œå•å…ƒæµ‹è¯•çš„éªŒè¯

### ç›®å½•

```
â”œâ”€â”€ mock
â”œâ”€â”€ person
â”‚Â Â  â””â”€â”€ male.go
â””â”€â”€ user
    â”œâ”€â”€ user.go
    â””â”€â”€ user_test.go
```

### ç¼–å†™

#### interface æ–¹æ³•

æ‰“å¼€ person/male.go æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼š

```go
package person

type Male interface {
	Get(id int64) error
}
```

#### è°ƒç”¨æ–¹æ³•

æ‰“å¼€ user/user.go æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼š

```go
package user

import "github.com/EDDYCJY/mockd/person"

type User struct {
	Person person.Male
}

func NewUser(p person.Male) *User {
	return &User{Person: p}
}

func (u *User) GetUserInfo(id int64) error {
	return u.Person.Get(id)
}
```

#### ç”Ÿæˆ mock æ–‡ä»¶

å›åˆ° `mockd/` çš„æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```
$ mockgen -source=./person/male.go -destination=./mock/male_mock.go -package=mock
```

åœ¨æ‰§è¡Œå®Œæ¯•åï¼Œå¯ä»¥å‘ç° `mock/` ç›®å½•ä¸‹å¤šå‡ºäº† male_mock.go æ–‡ä»¶ï¼Œè¿™å°±æ˜¯ mock æ–‡ä»¶ã€‚é‚£ä¹ˆå‘½ä»¤ä¸­çš„æŒ‡ä»¤åˆåˆ†åˆ«æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå¦‚ä¸‹ï¼š

- -sourceï¼šè®¾ç½®éœ€è¦æ¨¡æ‹Ÿï¼ˆmockï¼‰çš„æ¥å£æ–‡ä»¶
- -destinationï¼šè®¾ç½® mock æ–‡ä»¶è¾“å‡ºçš„åœ°æ–¹ï¼Œè‹¥ä¸è®¾ç½®åˆ™æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºä¸­
- -packageï¼šè®¾ç½® mock æ–‡ä»¶çš„åŒ…åï¼Œè‹¥ä¸è®¾ç½®åˆ™ä¸º `mock_` å‰ç¼€åŠ ä¸Šæ–‡ä»¶åï¼ˆå¦‚æœ¬æ–‡çš„åŒ…åä¼šä¸º mock_personï¼‰

æƒ³äº†è§£æ›´å¤šçš„æŒ‡ä»¤ç¬¦ï¼Œå¯å‚è§ [å®˜æ–¹æ–‡æ¡£](https://github.com/golang/mock#running-mockgen)

##### è¾“å‡ºçš„ mock æ–‡ä»¶

```go
// Code generated by MockGen. DO NOT EDIT.
// Source: ./person/male.go

// Package mock is a generated GoMock package.
package mock

import (
	gomock "github.com/golang/mock/gomock"
	reflect "reflect"
)

// MockMale is a mock of Male interface
type MockMale struct {
	ctrl     *gomock.Controller
	recorder *MockMaleMockRecorder
}

// MockMaleMockRecorder is the mock recorder for MockMale
type MockMaleMockRecorder struct {
	mock *MockMale
}

// NewMockMale creates a new mock instance
func NewMockMale(ctrl *gomock.Controller) *MockMale {
	mock := &MockMale{ctrl: ctrl}
	mock.recorder = &MockMaleMockRecorder{mock}
	return mock
}

// EXPECT returns an object that allows the caller to indicate expected use
func (m *MockMale) EXPECT() *MockMaleMockRecorder {
	return m.recorder
}

// Get mocks base method
func (m *MockMale) Get(id int64) error {
	ret := m.ctrl.Call(m, "Get", id)
	ret0, _ := ret[0].(error)
	return ret0
}

// Get indicates an expected call of Get
func (mr *MockMaleMockRecorder) Get(id interface{}) *gomock.Call {
	return mr.mock.ctrl.RecordCallWithMethodType(mr.mock, "Get", reflect.TypeOf((*MockMale)(nil).Get), id)
}
```

#### æµ‹è¯•ç”¨ä¾‹

æ‰“å¼€ user/user_test.go æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼š

```go
package user

import (
	"testing"

	"github.com/EDDYCJY/mockd/mock"

	"github.com/golang/mock/gomock"
)

func TestUser_GetUserInfo(t *testing.T) {
	ctl := gomock.NewController(t)
	defer ctl.Finish()

	var id int64 = 1
	mockMale := mock.NewMockMale(ctl)
	gomock.InOrder(
		mockMale.EXPECT().Get(id).Return(nil),
	)

	user := NewUser(mockMale)
	err := user.GetUserInfo(id)
	if err != nil {
		t.Errorf("user.GetUserInfo err: %v", err)
	}
}
```

1. gomock.NewControllerï¼šè¿”å› `gomock.Controller`ï¼Œå®ƒä»£è¡¨ mock ç”Ÿæ€ç³»ç»Ÿä¸­çš„é¡¶çº§æ§ä»¶ã€‚å®šä¹‰äº† mock å¯¹è±¡çš„èŒƒå›´ã€ç”Ÿå‘½å‘¨æœŸå’ŒæœŸå¾…å€¼ã€‚å¦å¤–å®ƒåœ¨å¤šä¸ª goroutine ä¸­æ˜¯å®‰å…¨çš„
2. mock.NewMockMaleï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ mock å®ä¾‹
3. gomock.InOrderï¼šå£°æ˜ç»™å®šçš„è°ƒç”¨åº”æŒ‰é¡ºåºè¿›è¡Œï¼ˆæ˜¯å¯¹ gomock.After çš„äºŒæ¬¡å°è£…ï¼‰
4. mockMale.EXPECT().Get(id).Return(nil)ï¼šè¿™é‡Œæœ‰ä¸‰ä¸ªæ­¥éª¤ï¼Œ`EXPECT()`è¿”å›ä¸€ä¸ªå…è®¸è°ƒç”¨è€…è®¾ç½®**æœŸæœ›**å’Œ**è¿”å›å€¼**çš„å¯¹è±¡ã€‚`Get(id)` æ˜¯è®¾ç½®å…¥å‚å¹¶è°ƒç”¨ mock å®ä¾‹ä¸­çš„æ–¹æ³•ã€‚`Return(nil)` æ˜¯è®¾ç½®å…ˆå‰è°ƒç”¨çš„æ–¹æ³•å‡ºå‚ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è®¾ç½®å…¥å‚å¹¶è°ƒç”¨ï¼Œæœ€åè®¾ç½®è¿”å›å€¼

5. NewUser(mockMale)ï¼šåˆ›å»º User å®ä¾‹ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™é‡Œ**æ³¨å…¥äº† mock å¯¹è±¡**ï¼Œå› æ­¤å®é™…åœ¨éšåçš„ `user.GetUserInfo(id)` è°ƒç”¨ï¼ˆå…¥å‚ï¼šid ä¸º 1ï¼‰ä¸­ã€‚å®ƒè°ƒç”¨çš„æ˜¯æˆ‘ä»¬äº‹å…ˆæ¨¡æ‹Ÿå¥½çš„ mock æ–¹æ³•
6. ctl.Finish()ï¼šè¿›è¡Œ mock ç”¨ä¾‹çš„æœŸæœ›å€¼æ–­è¨€ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ `defer` å»¶è¿Ÿæ‰§è¡Œï¼Œä»¥é˜²æ­¢æˆ‘ä»¬å¿˜è®°è¿™ä¸€æ“ä½œ

### æµ‹è¯•

å›åˆ° `mockd/` çš„æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```
$ go test ./user
ok  	github.com/EDDYCJY/mockd/user
```

çœ‹åˆ°è¿™æ ·çš„ç»“æœï¼Œå°±å¤§åŠŸå‘Šæˆå•¦ï¼ä½ å¯ä»¥è‡ªå·±è°ƒæ•´ä¸€ä¸‹ `Return()` çš„è¿”å›å€¼ï¼Œä»¥æ­¤å¾—åˆ°ä¸ä¸€æ ·çš„æµ‹è¯•ç»“æœå“¦ ğŸ˜„

## æŸ¥çœ‹æµ‹è¯•æƒ…å†µ

### æµ‹è¯•è¦†ç›–ç‡

```
$ go test -cover ./user
ok  	github.com/EDDYCJY/mockd/user	(cached)	coverage: 100.0% of statements
```

å¯é€šè¿‡è®¾ç½® `-cover` æ ‡å¿—ç¬¦æ¥å¼€å¯è¦†ç›–ç‡çš„ç»Ÿè®¡ï¼Œå±•ç¤ºå†…å®¹ä¸º `coverage: 100.0%`ã€‚

### å¯è§†åŒ–ç•Œé¢

1. ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡çš„ profile æ–‡ä»¶

```
$ go test ./... -coverprofile=cover.out
```

2. åˆ©ç”¨ profile æ–‡ä»¶ç”Ÿæˆå¯è§†åŒ–ç•Œé¢

```
$ go tool cover -html=cover.out
```

3. æŸ¥çœ‹å¯è§†åŒ–ç•Œé¢ï¼Œåˆ†æè¦†ç›–æƒ…å†µ

![image](https://s2.ax1x.com/2020/02/27/3wKu7R.jpg)

## æ›´å¤š

### ä¸€ã€å¸¸ç”¨ mock æ–¹æ³•

#### è°ƒç”¨æ–¹æ³•

- Call.Do()ï¼šå£°æ˜åœ¨åŒ¹é…æ—¶è¦è¿è¡Œçš„æ“ä½œ
- Call.DoAndReturn()ï¼šå£°æ˜åœ¨åŒ¹é…è°ƒç”¨æ—¶è¦è¿è¡Œçš„æ“ä½œï¼Œå¹¶ä¸”æ¨¡æ‹Ÿè¿”å›è¯¥å‡½æ•°çš„è¿”å›å€¼
- Call.MaxTimes()ï¼šè®¾ç½®æœ€å¤§çš„è°ƒç”¨æ¬¡æ•°ä¸º n æ¬¡
- Call.MinTimes()ï¼šè®¾ç½®æœ€å°çš„è°ƒç”¨æ¬¡æ•°ä¸º n æ¬¡
- Call.AnyTimes()ï¼šå…è®¸è°ƒç”¨æ¬¡æ•°ä¸º 0 æ¬¡æˆ–æ›´å¤šæ¬¡
- Call.Times()ï¼šè®¾ç½®è°ƒç”¨æ¬¡æ•°ä¸º n æ¬¡

#### å‚æ•°åŒ¹é…

- gomock.Any()ï¼šåŒ¹é…ä»»æ„å€¼
- gomock.Eq()ï¼šé€šè¿‡åå°„åŒ¹é…åˆ°æŒ‡å®šçš„ç±»å‹å€¼ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®
- gomock.Nil()ï¼šè¿”å› nil

å»ºè®®æ›´å¤šçš„æ–¹æ³•å¯å‚è§ [å®˜æ–¹æ–‡æ¡£](https://godoc.org/github.com/golang/mock/gomock#pkg-index)

### äºŒã€ç”Ÿæˆå¤šä¸ª mock æ–‡ä»¶

ä½ å¯èƒ½ä¼šæƒ³ä¸€æ¡æ¡å‘½ä»¤ç”Ÿæˆ mock æ–‡ä»¶ï¼Œå²‚ä¸å¾—å´©æºƒï¼Ÿ

å½“ç„¶ï¼Œå®˜æ–¹æä¾›äº†æ›´æ–¹ä¾¿çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `go:generate` æ¥å®Œæˆæ‰¹é‡å¤„ç†çš„åŠŸèƒ½

```
go generate [-run regexp] [-n] [-v] [-x] [build flags] [file.go... | packages]
```

#### ä¿®æ”¹ interface æ–¹æ³•

æ‰“å¼€ person/male.go æ–‡ä»¶ï¼Œä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š

```go
package person

//go:generate mockgen -destination=../mock/male_mock.go -package=mock github.com/EDDYCJY/mockd/person Male

type Male interface {
	Get(id int64) error
}
```

æˆ‘ä»¬å…³æ³¨åˆ° `go:generate` è¿™æ¡è¯­å¥ï¼Œå¯åˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†ï¼š

1. å£°æ˜ `//go:generate` ï¼ˆæ³¨æ„ä¸è¦ç•™ç©ºæ ¼ï¼‰
2. ä½¿ç”¨ `mockgen` å‘½ä»¤
3. å®šä¹‰ `-destination`
4. å®šä¹‰ `-package`
5. å®šä¹‰ `source`ï¼Œæ­¤å¤„ä¸º person çš„åŒ…è·¯å¾„
6. å®šä¹‰ `interfaces`ï¼Œæ­¤å¤„ä¸º `Male`

#### é‡æ–°ç”Ÿæˆ mock æ–‡ä»¶

å›åˆ° `mockd/` çš„æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```
$ go generate ./...
```

å†æ£€æŸ¥ `mock/` å‘ç°ä¹Ÿå·²ç»æ­£ç¡®ç”Ÿæˆäº†ï¼Œåœ¨å¤šä¸ªæ–‡ä»¶æ—¶æ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿å‘¢ ğŸ¤©

## æ€»ç»“

åœ¨å•å…ƒæµ‹è¯•è¿™ä¸€ç¯ï¼Œgomock ç»™æˆ‘ä»¬æä¾›äº†æå¤§çš„ä¾¿åˆ©ã€‚èƒ½å¤Ÿ mock æ‰è®¸è®¸å¤šå¤šçš„ä¾èµ–é¡¹

å…¶ä¸­è¿˜æœ‰å¾ˆå¤šçš„ä½¿ç”¨æ–¹å¼å’ŒåŠŸèƒ½ã€‚ä½ å¯ä»¥ mark ä½åè¯¦ç»†é˜…è¯»ä¸‹å®˜æ–¹æ–‡æ¡£ï¼Œè®°å¿†ä¼šæ›´æ·±åˆ»