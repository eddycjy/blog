---

title:      "ã€Œè¿è½½åå››ã€å®ç°å¯¼å‡ºã€å¯¼å…¥ Excel"
date:       2018-06-14 12:00:00
author:     "ç…é±¼"
toc: true
tags:
    - go
    - gin
---

## çŸ¥è¯†ç‚¹

- å¯¼å‡ºåŠŸèƒ½çš„å®ç°

## æœ¬æ–‡ç›®æ ‡

åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†å®ç°å¯¹æ ‡ç­¾ä¿¡æ¯çš„å¯¼å‡ºã€å¯¼å…¥åŠŸèƒ½ï¼Œè¿™æ˜¯å¾ˆæ ‡é…åŠŸèƒ½äº†ï¼Œå¸Œæœ›ä½ æŒæ¡åŸºç¡€çš„ä½¿ç”¨æ–¹å¼ã€‚

å¦å¤–åœ¨æœ¬æ–‡æˆ‘ä»¬ä½¿ç”¨äº† 2 ä¸ª Excel çš„åŒ…ï¼Œexcelize æœ€åˆçš„ XML æ ¼å¼æ–‡ä»¶çš„ä¸€äº›ç»“æ„ï¼Œæ˜¯é€šè¿‡ tealeg/xlsx æ ¼å¼æ–‡ä»¶ç»“æ„æ¼”åŒ–è€Œæ¥çš„ï¼Œå› æ­¤ç‰¹æ„åœ¨æ­¤éƒ½å±•ç¤ºäº†ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„åœºæ™¯å’Œå–œçˆ±å»ä½¿ç”¨ã€‚

## é…ç½®

é¦–å…ˆè¦æŒ‡å®šå¯¼å‡ºçš„ Excel æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ï¼Œåœ¨ app.ini ä¸­å¢åŠ é…ç½®ï¼š

```ini
[app]
...

ExportSavePath = export/
```

ä¿®æ”¹ setting.go çš„ App structï¼š

```go
type App struct {
	JwtSecret       string
	PageSize        int
	PrefixUrl       string

	RuntimeRootPath string

	ImageSavePath  string
	ImageMaxSize   int
	ImageAllowExts []string

	ExportSavePath string

	LogSavePath string
	LogSaveName string
	LogFileExt  string
	TimeFormat  string
}
```

åœ¨è¿™é‡Œéœ€å¢åŠ  ExportSavePath é…ç½®é¡¹ï¼Œå¦å¤–å°†å…ˆå‰ ImagePrefixUrl æ”¹ä¸º PrefixUrl ç”¨äºæ”¯æ’‘ä¸¤è€…çš„ HOST è·å–

ï¼ˆæ³¨æ„ä¿®æ”¹ image.go çš„ GetImageFullUrl æ–¹æ³•ï¼‰

## pkg

æ–°å»º pkg/export/excel.go æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š

```go
package export

import "github.com/EDDYCJY/go-gin-example/pkg/setting"

func GetExcelFullUrl(name string) string {
	return setting.AppSetting.PrefixUrl + "/" + GetExcelPath() + name
}

func GetExcelPath() string {
	return setting.AppSetting.ExportSavePath
}

func GetExcelFullPath() string {
	return setting.AppSetting.RuntimeRootPath + GetExcelPath()
}
```

è¿™é‡Œç¼–å†™äº†ä¸€äº›å¸¸ç”¨çš„æ–¹æ³•ï¼Œä»¥åå–å€¼æ–¹å¼å¦‚æœæœ‰å˜åŠ¨ï¼Œç›´æ¥æ”¹å†…éƒ¨ä»£ç å³å¯ï¼Œå¯¹å¤–ä¸å¯è§

## å°è¯•ä¸€ä¸‹æ ‡å‡†åº“

```go
f, err := os.Create(export.GetExcelFullPath() + "test.csv")
if err != nil {
	panic(err)
}
defer f.Close()

f.WriteString("\xEF\xBB\xBF")

w := csv.NewWriter(f)
data := [][]string{
	{"1", "test1", "test1-1"},
	{"2", "test2", "test2-1"},
	{"3", "test3", "test3-1"},
}

w.WriteAll(data)
```

åœ¨ Go æä¾›çš„æ ‡å‡†åº“ encoding/csv ä¸­ï¼Œå¤©ç„¶çš„æ”¯æŒ csv æ–‡ä»¶çš„è¯»å–å’Œå¤„ç†ï¼Œåœ¨æœ¬æ®µä»£ç ä¸­ï¼Œåšäº†å¦‚ä¸‹å·¥ä½œï¼š

1ã€os.Createï¼š

åˆ›å»ºäº†ä¸€ä¸ª test.csv æ–‡ä»¶

2ã€f.WriteString("\xEF\xBB\xBF")ï¼š

`\xEF\xBB\xBF` æ˜¯ UTF-8 BOM çš„ 16 è¿›åˆ¶æ ¼å¼ï¼Œåœ¨è¿™é‡Œçš„ç”¨å¤„æ˜¯æ ‡è¯†æ–‡ä»¶çš„ç¼–ç æ ¼å¼ï¼Œé€šå¸¸ä¼šå‡ºç°åœ¨æ–‡ä»¶çš„å¼€å¤´ï¼Œå› æ­¤ç¬¬ä¸€æ­¥å°±è¦å°†å…¶å†™å…¥ã€‚å¦‚æœä¸æ ‡è¯† UTF-8 çš„ç¼–ç æ ¼å¼çš„è¯ï¼Œå†™å…¥çš„æ±‰å­—ä¼šæ˜¾ç¤ºä¸ºä¹±ç 

3ã€csv.NewWriterï¼š

```go
func NewWriter(w io.Writer) *Writer {
	return &Writer{
		Comma: ',',
		w:     bufio.NewWriter(w),
	}
}
```

4ã€w.WriteAllï¼š

```go
func (w *Writer) WriteAll(records [][]string) error {
	for _, record := range records {
		err := w.Write(record)
		if err != nil {
			return err
		}
	}
	return w.w.Flush()
}
```

WriteAll å®é™…æ˜¯å¯¹ Write çš„å°è£…ï¼Œéœ€è¦æ³¨æ„åœ¨æœ€åè°ƒç”¨äº† `w.w.Flush()`ï¼Œè¿™å……åˆ†äº†è¯´æ˜äº† WriteAll çš„ä½¿ç”¨åœºæ™¯ï¼Œä½ å¯ä»¥æƒ³æƒ³ä½œè€…çš„è®¾è®¡ç”¨æ„

## å¯¼å‡º

### Service æ–¹æ³•

æ‰“å¼€ service/tag.goï¼Œå¢åŠ  Export æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```go
func (t *Tag) Export() (string, error) {
	tags, err := t.GetAll()
	if err != nil {
		return "", err
	}

	file := xlsx.NewFile()
	sheet, err := file.AddSheet("æ ‡ç­¾ä¿¡æ¯")
	if err != nil {
		return "", err
	}

	titles := []string{"ID", "åç§°", "åˆ›å»ºäºº", "åˆ›å»ºæ—¶é—´", "ä¿®æ”¹äºº", "ä¿®æ”¹æ—¶é—´"}
	row := sheet.AddRow()

	var cell *xlsx.Cell
	for _, title := range titles {
		cell = row.AddCell()
		cell.Value = title
	}

	for _, v := range tags {
		values := []string{
			strconv.Itoa(v.ID),
			v.Name,
			v.CreatedBy,
			strconv.Itoa(v.CreatedOn),
			v.ModifiedBy,
			strconv.Itoa(v.ModifiedOn),
		}

		row = sheet.AddRow()
		for _, value := range values {
			cell = row.AddCell()
			cell.Value = value
		}
	}

	time := strconv.Itoa(int(time.Now().Unix()))
	filename := "tags-" + time + ".xlsx"

	fullPath := export.GetExcelFullPath() + filename
	err = file.Save(fullPath)
	if err != nil {
		return "", err
	}

	return filename, nil
}
```

## routers å…¥å£

æ‰“å¼€ routers/api/v1/tag.goï¼Œå¢åŠ å¦‚ä¸‹æ–¹æ³•ï¼š

```go
func ExportTag(c *gin.Context) {
	appG := app.Gin{C: c}
	name := c.PostForm("name")
	state := -1
	if arg := c.PostForm("state"); arg != "" {
		state = com.StrTo(arg).MustInt()
	}

	tagService := tag_service.Tag{
		Name:  name,
		State: state,
	}

	filename, err := tagService.Export()
	if err != nil {
		appG.Response(http.StatusOK, e.ERROR_EXPORT_TAG_FAIL, nil)
		return
	}

	appG.Response(http.StatusOK, e.SUCCESS, map[string]string{
		"export_url":      export.GetExcelFullUrl(filename),
		"export_save_url": export.GetExcelPath() + filename,
	})
}
```

### è·¯ç”±

åœ¨ routers/router.go æ–‡ä»¶ä¸­å¢åŠ è·¯ç”±æ–¹æ³•ï¼Œå¦‚ä¸‹

```go
apiv1 := r.Group("/api/v1")
apiv1.Use(jwt.JWT())
{
	...
	//å¯¼å‡ºæ ‡ç­¾
	r.POST("/tags/export", v1.ExportTag)
}
```

### éªŒè¯æ¥å£

è®¿é—® `http://127.0.0.1:8000/tags/export`ï¼Œç»“æœå¦‚ä¸‹ï¼š

```json
{
  "code": 200,
  "data": {
    "export_save_url": "export/tags-1528903393.xlsx",
    "export_url": "http://127.0.0.1:8000/export/tags-1528903393.xlsx"
  },
  "msg": "ok"
}
```

æœ€ç»ˆé€šè¿‡æ¥å£è¿”å›äº†å¯¼å‡ºæ–‡ä»¶çš„åœ°å€å’Œä¿å­˜åœ°å€

### StaticFS

é‚£ä½ æƒ³æƒ³ï¼Œç°åœ¨ç›´æ¥è®¿é—®åœ°å€è‚¯å®šæ˜¯æ— æ³•ä¸‹è½½æ–‡ä»¶çš„ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•åšå‘¢ï¼Ÿ

æ‰“å¼€ router.go æ–‡ä»¶ï¼Œå¢åŠ ä»£ç å¦‚ä¸‹ï¼š

```go
r.StaticFS("/export", http.Dir(export.GetExcelFullPath()))
```

è‹¥ä½ ä¸ç†è§£ï¼Œå¼ºçƒˆå»ºè®®æ¸©ä¹ ä¸‹å‰é¢çš„ç« èŠ‚ï¼Œä¸¾ä¸€åä¸‰

## éªŒè¯ä¸‹è½½

å†æ¬¡è®¿é—®ä¸Šé¢çš„ export_url ï¼Œå¦‚ï¼š`http://127.0.0.1:8000/export/tags-1528903393.xlsx`ï¼Œæ˜¯ä¸æ˜¯æˆåŠŸäº†å‘¢ï¼Ÿ

## å¯¼å…¥

### Service æ–¹æ³•

æ‰“å¼€ service/tag.goï¼Œå¢åŠ  Import æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```go
func (t *Tag) Import(r io.Reader) error {
	xlsx, err := excelize.OpenReader(r)
	if err != nil {
		return err
	}

	rows := xlsx.GetRows("æ ‡ç­¾ä¿¡æ¯")
	for irow, row := range rows {
		if irow > 0 {
			var data []string
			for _, cell := range row {
				data = append(data, cell)
			}

			models.AddTag(data[1], 1, data[2])
		}
	}

	return nil
}
```

## routers å…¥å£

æ‰“å¼€ routers/api/v1/tag.goï¼Œå¢åŠ å¦‚ä¸‹æ–¹æ³•ï¼š

```go
func ImportTag(c *gin.Context) {
	appG := app.Gin{C: c}

	file, _, err := c.Request.FormFile("file")
	if err != nil {
		logging.Warn(err)
		appG.Response(http.StatusOK, e.ERROR, nil)
		return
	}

	tagService := tag_service.Tag{}
	err = tagService.Import(file)
	if err != nil {
		logging.Warn(err)
		appG.Response(http.StatusOK, e.ERROR_IMPORT_TAG_FAIL, nil)
		return
	}

	appG.Response(http.StatusOK, e.SUCCESS, nil)
}
```

### è·¯ç”±

åœ¨ routers/router.go æ–‡ä»¶ä¸­å¢åŠ è·¯ç”±æ–¹æ³•ï¼Œå¦‚ä¸‹

```go
apiv1 := r.Group("/api/v1")
apiv1.Use(jwt.JWT())
{
	...
	//å¯¼å…¥æ ‡ç­¾
	r.POST("/tags/import", v1.ImportTag)
}
```

### éªŒè¯

![image](https://s2.ax1x.com/2020/02/15/1xKtSA.jpg)

åœ¨è¿™é‡Œæˆ‘ä»¬å°†å…ˆå‰å¯¼å‡ºçš„ Excel æ–‡ä»¶ä½œä¸ºå…¥å‚ï¼Œè®¿é—® `http://127.0.0.01:8000/tags/import`ï¼Œæ£€æŸ¥è¿”å›å’Œæ•°æ®æ˜¯å¦æ­£ç¡®å…¥åº“

## æ€»ç»“

åœ¨æœ¬æ–‡ä¸­ï¼Œç®€å•ä»‹ç»äº† Excel çš„å¯¼å…¥ã€å¯¼å‡ºçš„ä½¿ç”¨æ–¹å¼ï¼Œä½¿ç”¨äº†ä»¥ä¸‹ 2 ä¸ªåŒ…ï¼š

- [tealeg/xlsx](https://github.com/tealeg/xlsx)
- [360EntSecGroup-Skylar/excelize](https://github.com/360EntSecGroup-Skylar/excelize)

ä½ å¯ä»¥ç»†ç»†é˜…è¯»ä¸€ä¸‹å®ƒçš„å®ç°å’Œä½¿ç”¨æ–¹å¼ï¼Œå¯¹ä½ çš„æŠŠæ§æ›´æœ‰å¸®åŠ© ğŸ¤”

## è¯¾å¤–

- tagï¼šå¯¼å‡ºä½¿ç”¨ excelize çš„æ–¹å¼å»å®ç°ï¼ˆå¯èƒ½ä½ ä¼šå‘ç°æ›´ç®€å•å“¦ï¼‰
- tagï¼šå¯¼å…¥å»é‡åŠŸèƒ½å®ç°
- artice ï¼šå¯¼å…¥ã€å¯¼å‡ºåŠŸèƒ½å®ç°

ä¹Ÿä¸å¤±ä¸ºä½ å¾ˆå¥½çš„ç»ƒæ‰‹æœºä¼šï¼Œå¦‚æœæœ‰å…´è¶£ï¼Œå¯ä»¥è¯•è¯•

## å‚è€ƒ

### æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç 

- [go-gin-example](https://github.com/EDDYCJY/go-gin-example)

## å…³äº

### ä¿®æ”¹è®°å½•

- ç¬¬ä¸€ç‰ˆï¼š2018 å¹´ 02 æœˆ 16 æ—¥å‘å¸ƒæ–‡ç« 
- ç¬¬äºŒç‰ˆï¼š2019 å¹´ 10 æœˆ 02 æ—¥ä¿®æ”¹æ–‡ç« 

## ï¼Ÿ

å¦‚æœæœ‰ä»»ä½•ç–‘é—®æˆ–é”™è¯¯ï¼Œæ¬¢è¿åœ¨ [issues](https://github.com/EDDYCJY/blog) è¿›è¡Œæé—®æˆ–ç»™äºˆä¿®æ­£æ„è§ï¼Œå¦‚æœå–œæ¬¢æˆ–å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿ Starï¼Œå¯¹ä½œè€…æ˜¯ä¸€ç§é¼“åŠ±å’Œæ¨è¿›ã€‚

### æˆ‘çš„å…¬ä¼—å·

![image](https://image.eddycjy.com/8d0b0c3a11e74efd5fdfd7910257e70b.jpg)

