---

title:      "ã€Œè¿è½½åå…­ã€åœ¨å›¾ç‰‡ä¸Šç»˜åˆ¶æ–‡å­—"
date:       2018-07-07 12:00:00
author:     "ç…é±¼"
toc: true
tags:
    - go
    - gin
---

## çŸ¥è¯†ç‚¹

- å­—ä½“åº“ä½¿ç”¨
- å›¾ç‰‡åˆæˆ

## æœ¬æ–‡ç›®æ ‡

ä¸»è¦å®ç°**åˆå¹¶åçš„æµ·æŠ¥ä¸Šç»˜åˆ¶æ–‡å­—**çš„åŠŸèƒ½ï¼ˆè¿™ä¸ªéœ€æ±‚ä¹Ÿæ˜¯å¸¸è§çš„å¾ˆäº†ï¼‰ï¼Œå†…å®¹æ¯”è¾ƒç®€å•ã€‚

## å®ç°

è¿™é‡Œä½¿ç”¨çš„æ˜¯ [å¾®è½¯é›…é»‘](https://github.com/EDDYCJY/go-gin-example/blob/master/runtime/fonts/msyhbd.ttc) çš„å­—ä½“ï¼Œè¯·ç‚¹å‡»è¿›è¡Œä¸‹è½½å¹¶**å­˜æ”¾åˆ° runtime/fonts ç›®å½•**ä¸‹ï¼ˆå­—ä½“æ–‡ä»¶å  16 MB å¤§å°ï¼‰

### å®‰è£…

```
$ go get -u github.com/golang/freetype
```

### ç»˜åˆ¶æ–‡å­—

æ‰“å¼€ service/article_service/article_poster.go æ–‡ä»¶ï¼Œå¢åŠ ç»˜åˆ¶æ–‡å­—çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š

```go
type DrawText struct {
	JPG    draw.Image
	Merged *os.File

	Title string
	X0    int
	Y0    int
	Size0 float64

	SubTitle string
	X1       int
	Y1       int
	Size1    float64
}

func (a *ArticlePosterBg) DrawPoster(d *DrawText, fontName string) error {
	fontSource := setting.AppSetting.RuntimeRootPath + setting.AppSetting.FontSavePath + fontName
	fontSourceBytes, err := ioutil.ReadFile(fontSource)
	if err != nil {
		return err
	}

	trueTypeFont, err := freetype.ParseFont(fontSourceBytes)
	if err != nil {
		return err
	}

	fc := freetype.NewContext()
	fc.SetDPI(72)
	fc.SetFont(trueTypeFont)
	fc.SetFontSize(d.Size0)
	fc.SetClip(d.JPG.Bounds())
	fc.SetDst(d.JPG)
	fc.SetSrc(image.Black)

	pt := freetype.Pt(d.X0, d.Y0)
	_, err = fc.DrawString(d.Title, pt)
	if err != nil {
		return err
	}

	fc.SetFontSize(d.Size1)
	_, err = fc.DrawString(d.SubTitle, freetype.Pt(d.X1, d.Y1))
	if err != nil {
		return err
	}

	err = jpeg.Encode(d.Merged, d.JPG, nil)
	if err != nil {
		return err
	}

	return nil
}
```

è¿™é‡Œä¸»è¦ä½¿ç”¨äº† freetype åŒ…ï¼Œåˆ†åˆ«æ¶‰åŠå¦‚ä¸‹ç»†é¡¹ï¼š

1ã€freetype.NewContextï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Contextï¼Œä¼šå¯¹å…¶è®¾ç½®ä¸€äº›é»˜è®¤å€¼

```go
func NewContext() *Context {
	return &Context{
		r:        raster.NewRasterizer(0, 0),
		fontSize: 12,
		dpi:      72,
		scale:    12 << 6,
	}
}
```

2ã€fc.SetDPIï¼šè®¾ç½®å±å¹•æ¯è‹±å¯¸çš„åˆ†è¾¨ç‡

3ã€fc.SetFontï¼šè®¾ç½®ç”¨äºç»˜åˆ¶æ–‡æœ¬çš„å­—ä½“

4ã€fc.SetFontSizeï¼šä»¥ç£…ä¸ºå•ä½è®¾ç½®å­—ä½“å¤§å°

5ã€fc.SetClipï¼šè®¾ç½®å‰ªè£çŸ©å½¢ä»¥è¿›è¡Œç»˜åˆ¶

6ã€fc.SetDstï¼šè®¾ç½®ç›®æ ‡å›¾åƒ

7ã€fc.SetSrcï¼šè®¾ç½®ç»˜åˆ¶æ“ä½œçš„æºå›¾åƒï¼Œé€šå¸¸ä¸º [image.Uniform](https://golang.org/pkg/image/#Uniform)

```go
var (
        // Black is an opaque black uniform image.
        Black = NewUniform(color.Black)
        // White is an opaque white uniform image.
        White = NewUniform(color.White)
        // Transparent is a fully transparent uniform image.
        Transparent = NewUniform(color.Transparent)
        // Opaque is a fully opaque uniform image.
        Opaque = NewUniform(color.Opaque)
)
```

8ã€fc.DrawStringï¼šæ ¹æ® Pt çš„åæ ‡å€¼ç»˜åˆ¶ç»™å®šçš„æ–‡æœ¬å†…å®¹

### ä¸šåŠ¡é€»è¾‘

æ‰“å¼€ service/article_service/article_poster.go æ–¹æ³•ï¼Œåœ¨ Generate æ–¹æ³•å¢åŠ ç»˜åˆ¶æ–‡å­—çš„ä»£ç é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š

```go
func (a *ArticlePosterBg) Generate() (string, string, error) {
	fullPath := qrcode.GetQrCodeFullPath()
	fileName, path, err := a.Qr.Encode(fullPath)
	if err != nil {
		return "", "", err
	}

	if !a.CheckMergedImage(path) {
		...

		draw.Draw(jpg, jpg.Bounds(), bgImage, bgImage.Bounds().Min, draw.Over)
		draw.Draw(jpg, jpg.Bounds(), qrImage, qrImage.Bounds().Min.Sub(image.Pt(a.Pt.X, a.Pt.Y)), draw.Over)

		err = a.DrawPoster(&DrawText{
			JPG:    jpg,
			Merged: mergedF,

			Title: "Golang Gin ç³»åˆ—æ–‡ç« ",
			X0:    80,
			Y0:    160,
			Size0: 42,

			SubTitle: "---ç…é±¼",
			X1:       320,
			Y1:       220,
			Size1:    36,
		}, "msyhbd.ttc")

		if err != nil {
			return "", "", err
		}
	}

	return fileName, path, nil
}
```

## éªŒè¯

è®¿é—®ç”Ÿæˆæ–‡ç« æµ·æŠ¥çš„æ¥å£ `$HOST/api/v1/articles/poster/generate?token=$token`ï¼Œæ£€æŸ¥å…¶ç”Ÿæˆç»“æœï¼Œå¦‚ä¸‹å›¾

![image](https://s2.ax1x.com/2020/02/15/1xKBTS.jpg)

## æ€»ç»“

åœ¨æœ¬ç« èŠ‚åœ¨ [è¿è½½åäº”](https://github.com/EDDYCJY/blog/blob/master/golang/gin/2018-07-04-Gin%E5%AE%9E%E8%B7%B5-%E8%BF%9E%E8%BD%BD%E5%8D%81%E4%BA%94-%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81-%E5%90%88%E5%B9%B6%E6%B5%B7%E6%8A%A5.md) çš„åŸºç¡€ä¸Šå¢åŠ äº†ç»˜åˆ¶æ–‡å­—ï¼Œåœ¨å®ç°ä¸Šå¹¶ä¸å›°éš¾ï¼Œè€Œè¿™ä¸¤å—éœ€æ±‚ä¸€èˆ¬ä¼šåŒæ—¶å‡ºç°ï¼Œå¤§å®¶å¯ä»¥å¤šåŠ ç»ƒä¹ ï¼Œäº†è§£é‡Œé¢çš„é€»è¾‘å’Œå…¶ä»– API ğŸ˜

## å‚è€ƒ

### æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç 

- [go-gin-example](https://github.com/EDDYCJY/go-gin-example)

## å…³äº

### ä¿®æ”¹è®°å½•

- ç¬¬ä¸€ç‰ˆï¼š2018 å¹´ 02 æœˆ 16 æ—¥å‘å¸ƒæ–‡ç« 
- ç¬¬äºŒç‰ˆï¼š2019 å¹´ 10 æœˆ 02 æ—¥ä¿®æ”¹æ–‡ç« 

## ï¼Ÿ

å¦‚æœæœ‰ä»»ä½•ç–‘é—®æˆ–é”™è¯¯ï¼Œæ¬¢è¿åœ¨ [issues](https://github.com/EDDYCJY/blog) è¿›è¡Œæé—®æˆ–ç»™äºˆä¿®æ­£æ„è§ï¼Œå¦‚æœå–œæ¬¢æˆ–å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿ Starï¼Œå¯¹ä½œè€…æ˜¯ä¸€ç§é¼“åŠ±å’Œæ¨è¿›ã€‚

### æˆ‘çš„å…¬ä¼—å·

![image](https://image.eddycjy.com/8d0b0c3a11e74efd5fdfd7910257e70b.jpg)