---

title:      "ã€Œè¿è½½åäº”ã€ç”ŸæˆäºŒç»´ç ã€åˆå¹¶æµ·æŠ¥"
date:       2018-07-05 12:00:00
author:     "ç…é±¼"
toc: true
tags:
    - go
    - gin
---

## çŸ¥è¯†ç‚¹

- å›¾ç‰‡ç”Ÿæˆ
- äºŒç»´ç ç”Ÿæˆ

## æœ¬æ–‡ç›®æ ‡

åœ¨æ–‡ç« çš„è¯¦æƒ…é¡µä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šéœ€è¦å»å®£ä¼ å®ƒï¼Œè€Œç›®å‰æœ€å¸¸è§çš„å°±æ˜¯å‘æµ·æŠ¥äº†ï¼Œä»Šå¤©æˆ‘ä»¬å°†å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š

- ç”ŸæˆäºŒç»´ç 

- åˆå¹¶æµ·æŠ¥ï¼ˆèƒŒæ™¯å›¾ + äºŒç»´ç ï¼‰

## å®ç°

é¦–å…ˆï¼Œä½ éœ€è¦åœ¨ App é…ç½®é¡¹ä¸­å¢åŠ äºŒç»´ç åŠå…¶æµ·æŠ¥çš„å­˜å‚¨è·¯å¾„ï¼Œæˆ‘ä»¬çº¦å®šé…ç½®é¡¹åç§°ä¸º `QrCodeSavePath`ï¼Œå€¼ä¸º `qrcode/`ï¼Œç»è¿‡å¤šèŠ‚è¿è½½çš„ä½ åº”è¯¥èƒ½å¤Ÿå®Œæˆï¼Œè‹¥æœ‰ä¸æ‡‚å¯å‚ç…§ [go-gin-example](https://github.com/EDDYCJY/go-gin-example/blob/master/conf/app.ini#L14)ã€‚

## ç”ŸæˆäºŒç»´ç 

### å®‰è£…

```
$ go get -u github.com/boombuler/barcode
```

### å·¥å…·åŒ…

è€ƒè™‘ç”ŸæˆäºŒç»´ç è¿™ä¸€åŠ¨ä½œè´´åˆå·¥å…·åŒ…çš„å®šä¹‰ï¼Œä¸”æœ‰å…¬ç”¨çš„å¯èƒ½æ€§ï¼Œæ–°å»º pkg/qrcode/qrcode.go æ–‡ä»¶ï¼Œå†™å…¥å†…å®¹ï¼š

```go
package qrcode

import (
	"image/jpeg"

	"github.com/boombuler/barcode"
	"github.com/boombuler/barcode/qr"

	"github.com/EDDYCJY/go-gin-example/pkg/file"
	"github.com/EDDYCJY/go-gin-example/pkg/setting"
	"github.com/EDDYCJY/go-gin-example/pkg/util"
)

type QrCode struct {
	URL    string
	Width  int
	Height int
	Ext    string
	Level  qr.ErrorCorrectionLevel
	Mode   qr.Encoding
}

const (
	EXT_JPG = ".jpg"
)

func NewQrCode(url string, width, height int, level qr.ErrorCorrectionLevel, mode qr.Encoding) *QrCode {
	return &QrCode{
		URL:    url,
		Width:  width,
		Height: height,
		Level:  level,
		Mode:   mode,
		Ext:    EXT_JPG,
	}
}

func GetQrCodePath() string {
	return setting.AppSetting.QrCodeSavePath
}

func GetQrCodeFullPath() string {
	return setting.AppSetting.RuntimeRootPath + setting.AppSetting.QrCodeSavePath
}

func GetQrCodeFullUrl(name string) string {
	return setting.AppSetting.PrefixUrl + "/" + GetQrCodePath() + name
}

func GetQrCodeFileName(value string) string {
	return util.EncodeMD5(value)
}

func (q *QrCode) GetQrCodeExt() string {
	return q.Ext
}

func (q *QrCode) CheckEncode(path string) bool {
	src := path + GetQrCodeFileName(q.URL) + q.GetQrCodeExt()
	if file.CheckNotExist(src) == true {
		return false
	}

	return true
}

func (q *QrCode) Encode(path string) (string, string, error) {
	name := GetQrCodeFileName(q.URL) + q.GetQrCodeExt()
	src := path + name
	if file.CheckNotExist(src) == true {
		code, err := qr.Encode(q.URL, q.Level, q.Mode)
		if err != nil {
			return "", "", err
		}

		code, err = barcode.Scale(code, q.Width, q.Height)
		if err != nil {
			return "", "", err
		}

		f, err := file.MustOpen(name, path)
		if err != nil {
			return "", "", err
		}
		defer f.Close()

		err = jpeg.Encode(f, code, nil)
		if err != nil {
			return "", "", err
		}
	}

	return name, path, nil
}
```

è¿™é‡Œä¸»è¦èšç„¦ `func (q *QrCode) Encode` æ–¹æ³•ï¼Œåšäº†å¦‚ä¸‹äº‹æƒ…ï¼š

- è·å–äºŒç»´ç ç”Ÿæˆè·¯å¾„
- åˆ›å»ºäºŒç»´ç 
- ç¼©æ”¾äºŒç»´ç åˆ°æŒ‡å®šå¤§å°
- æ–°å»ºå­˜æ”¾äºŒç»´ç å›¾ç‰‡çš„æ–‡ä»¶
- å°†å›¾åƒï¼ˆäºŒç»´ç ï¼‰ä»¥ JPEG 4ï¼š2ï¼š0 åŸºçº¿æ ¼å¼å†™å…¥æ–‡ä»¶

å¦å¤–åœ¨ `jpeg.Encode(f, code, nil)` ä¸­ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å¯è®¾ç½®å…¶å›¾åƒè´¨é‡ï¼Œé»˜è®¤å€¼ä¸º 75

```go
// DefaultQuality is the default quality encoding parameter.
const DefaultQuality = 75

// Options are the encoding parameters.
// Quality ranges from 1 to 100 inclusive, higher is better.
type Options struct {
	Quality int
}
```

### è·¯ç”±æ–¹æ³•

1ã€ç¬¬ä¸€æ­¥

åœ¨ routers/api/v1/article.go æ–°å¢ GenerateArticlePoster æ–¹æ³•ç”¨äºæ¥å£å¼€å‘

2ã€ç¬¬äºŒæ­¥

åœ¨ routers/router.go çš„ apiv1 ä¸­æ–°å¢ `apiv1.POST("/articles/poster/generate", v1.GenerateArticlePoster)` è·¯ç”±

3ã€ç¬¬ä¸‰æ­¥

ä¿®æ”¹ GenerateArticlePoster æ–¹æ³•ï¼Œç¼–å†™å¯¹åº”çš„ç”Ÿæˆé€»è¾‘ï¼Œå¦‚ä¸‹ï¼š

```go
const (
	QRCODE_URL = "https://github.com/EDDYCJY/blog#gin%E7%B3%BB%E5%88%97%E7%9B%AE%E5%BD%95"
)

func GenerateArticlePoster(c *gin.Context) {
	appG := app.Gin{c}
	qrc := qrcode.NewQrCode(QRCODE_URL, 300, 300, qr.M, qr.Auto)
	path := qrcode.GetQrCodeFullPath()
	_, _, err := qrc.Encode(path)
	if err != nil {
		appG.Response(http.StatusOK, e.ERROR, nil)
		return
	}

	appG.Response(http.StatusOK, e.SUCCESS, nil)
}
```

### éªŒè¯

é€šè¿‡ POST æ–¹æ³•è®¿é—® `http://127.0.0.1:8000/api/v1/articles/poster/generate?token=$token`ï¼ˆæ³¨æ„ \$tokenï¼‰

![image](https://s2.ax1x.com/2020/02/15/1xQmb6.jpg)

é€šè¿‡æ£€æŸ¥ä¸¤ä¸ªç‚¹ç¡®å®šåŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œå¦‚ä¸‹ï¼š

1ã€è®¿é—®ç»“æœæ˜¯å¦ 200

2ã€æœ¬åœ°ç›®å½•æ˜¯å¦æˆåŠŸç”ŸæˆäºŒç»´ç å›¾ç‰‡

![image](https://s2.ax1x.com/2020/02/15/1xQCUU.jpg)

## åˆå¹¶æµ·æŠ¥

åœ¨è¿™ä¸€èŠ‚ï¼Œå°†å®ç°äºŒç»´ç å›¾ç‰‡ä¸èƒŒæ™¯å›¾åˆå¹¶æˆæ–°çš„ä¸€å¼ å›¾ï¼Œå¯ç”¨äºå¸¸è§çš„å®£ä¼ æµ·æŠ¥ç­‰ä¸šåŠ¡åœºæ™¯

### èƒŒæ™¯å›¾

![image](https://s2.ax1x.com/2020/02/15/1xMXgs.jpg)

å°†èƒŒæ™¯å›¾å¦å­˜ä¸º runtime/qrcode/bg.jpgï¼ˆå®é™…åº”ç”¨ï¼Œå¯å­˜åœ¨ OSS æˆ–å…¶ä»–åœ°æ–¹ï¼‰

### service æ–¹æ³•

æ‰“å¼€ service/article_service ç›®å½•ï¼Œæ–°å»º article_poster.go æ–‡ä»¶ï¼Œå†™å…¥å†…å®¹ï¼š

```go
package article_service

import (
	"image"
	"image/draw"
	"image/jpeg"
	"os"

	"github.com/EDDYCJY/go-gin-example/pkg/file"
	"github.com/EDDYCJY/go-gin-example/pkg/qrcode"
)

type ArticlePoster struct {
	PosterName string
	*Article
	Qr *qrcode.QrCode
}

func NewArticlePoster(posterName string, article *Article, qr *qrcode.QrCode) *ArticlePoster {
	return &ArticlePoster{
		PosterName: posterName,
		Article:    article,
		Qr:         qr,
	}
}

func GetPosterFlag() string {
	return "poster"
}

func (a *ArticlePoster) CheckMergedImage(path string) bool {
	if file.CheckNotExist(path+a.PosterName) == true {
		return false
	}

	return true
}

func (a *ArticlePoster) OpenMergedImage(path string) (*os.File, error) {
	f, err := file.MustOpen(a.PosterName, path)
	if err != nil {
		return nil, err
	}

	return f, nil
}

type ArticlePosterBg struct {
	Name string
	*ArticlePoster
	*Rect
	*Pt
}

type Rect struct {
	Name string
	X0   int
	Y0   int
	X1   int
	Y1   int
}

type Pt struct {
	X int
	Y int
}

func NewArticlePosterBg(name string, ap *ArticlePoster, rect *Rect, pt *Pt) *ArticlePosterBg {
	return &ArticlePosterBg{
		Name:          name,
		ArticlePoster: ap,
		Rect:          rect,
		Pt:            pt,
	}
}

func (a *ArticlePosterBg) Generate() (string, string, error) {
	fullPath := qrcode.GetQrCodeFullPath()
	fileName, path, err := a.Qr.Encode(fullPath)
	if err != nil {
		return "", "", err
	}

	if !a.CheckMergedImage(path) {
		mergedF, err := a.OpenMergedImage(path)
		if err != nil {
			return "", "", err
		}
		defer mergedF.Close()

		bgF, err := file.MustOpen(a.Name, path)
		if err != nil {
			return "", "", err
		}
		defer bgF.Close()

		qrF, err := file.MustOpen(fileName, path)
		if err != nil {
			return "", "", err
		}
		defer qrF.Close()

		bgImage, err := jpeg.Decode(bgF)
		if err != nil {
			return "", "", err
		}
		qrImage, err := jpeg.Decode(qrF)
		if err != nil {
			return "", "", err
		}

		jpg := image.NewRGBA(image.Rect(a.Rect.X0, a.Rect.Y0, a.Rect.X1, a.Rect.Y1))

		draw.Draw(jpg, jpg.Bounds(), bgImage, bgImage.Bounds().Min, draw.Over)
		draw.Draw(jpg, jpg.Bounds(), qrImage, qrImage.Bounds().Min.Sub(image.Pt(a.Pt.X, a.Pt.Y)), draw.Over)

		jpeg.Encode(mergedF, jpg, nil)
	}

	return fileName, path, nil
}
```

è¿™é‡Œé‡ç‚¹ç•™æ„ `func (a *ArticlePosterBg) Generate()` æ–¹æ³•ï¼Œåšäº†å¦‚ä¸‹äº‹æƒ…ï¼š

- è·å–äºŒç»´ç å­˜å‚¨è·¯å¾„
- ç”ŸæˆäºŒç»´ç å›¾åƒ
- æ£€æŸ¥åˆå¹¶åå›¾åƒï¼ˆæŒ‡çš„æ˜¯å­˜æ”¾åˆå¹¶åçš„æµ·æŠ¥ï¼‰æ˜¯å¦å­˜åœ¨
- è‹¥ä¸å­˜åœ¨ï¼Œåˆ™ç”Ÿæˆå¾…åˆå¹¶çš„å›¾åƒ mergedF
- æ‰“å¼€äº‹å…ˆå­˜æ”¾çš„èƒŒæ™¯å›¾ bgF
- æ‰“å¼€ç”Ÿæˆçš„äºŒç»´ç å›¾åƒ qrF
- è§£ç  bgF å’Œ qrF è¿”å› image.Image
- åˆ›å»ºä¸€ä¸ªæ–°çš„ RGBA å›¾åƒ
- åœ¨ RGBA å›¾åƒä¸Šç»˜åˆ¶ èƒŒæ™¯å›¾ï¼ˆbgFï¼‰
- åœ¨å·²ç»˜åˆ¶èƒŒæ™¯å›¾çš„ RGBA å›¾åƒä¸Šï¼Œåœ¨æŒ‡å®š Point ä¸Šç»˜åˆ¶äºŒç»´ç å›¾åƒï¼ˆqrFï¼‰
- å°†ç»˜åˆ¶å¥½çš„ RGBA å›¾åƒä»¥ JPEG 4ï¼š2ï¼š0 åŸºçº¿æ ¼å¼å†™å…¥åˆå¹¶åçš„å›¾åƒæ–‡ä»¶ï¼ˆmergedFï¼‰

### é”™è¯¯ç 

æ–°å¢ [é”™è¯¯ç ](https://github.com/EDDYCJY/go-gin-example/blob/master/pkg/e/code.go#L27)ï¼Œ[é”™è¯¯æç¤º](https://github.com/EDDYCJY/go-gin-example/blob/master/pkg/e/msg.go#L25)

### è·¯ç”±æ–¹æ³•

æ‰“å¼€ routers/api/v1/article.go æ–‡ä»¶ï¼Œä¿®æ”¹ GenerateArticlePoster æ–¹æ³•ï¼Œç¼–å†™æœ€ç»ˆçš„ä¸šåŠ¡é€»è¾‘ï¼ˆå«ç”ŸæˆäºŒç»´ç åŠåˆå¹¶æµ·æŠ¥ï¼‰ï¼Œå¦‚ä¸‹ï¼š

```go
const (
	QRCODE_URL = "https://github.com/EDDYCJY/blog#gin%E7%B3%BB%E5%88%97%E7%9B%AE%E5%BD%95"
)

func GenerateArticlePoster(c *gin.Context) {
	appG := app.Gin{c}
	article := &article_service.Article{}
	qr := qrcode.NewQrCode(QRCODE_URL, 300, 300, qr.M, qr.Auto) // ç›®å‰å†™æ­» gin ç³»åˆ—è·¯å¾„ï¼Œå¯è‡ªè¡Œå¢åŠ ä¸šåŠ¡é€»è¾‘
	posterName := article_service.GetPosterFlag() + "-" + qrcode.GetQrCodeFileName(qr.URL) + qr.GetQrCodeExt()
	articlePoster := article_service.NewArticlePoster(posterName, article, qr)
	articlePosterBgService := article_service.NewArticlePosterBg(
		"bg.jpg",
		articlePoster,
		&article_service.Rect{
			X0: 0,
			Y0: 0,
			X1: 550,
			Y1: 700,
		},
		&article_service.Pt{
			X: 125,
			Y: 298,
		},
	)

	_, filePath, err := articlePosterBgService.Generate()
	if err != nil {
		appG.Response(http.StatusOK, e.ERROR_GEN_ARTICLE_POSTER_FAIL, nil)
		return
	}

	appG.Response(http.StatusOK, e.SUCCESS, map[string]string{
		"poster_url":      qrcode.GetQrCodeFullUrl(posterName),
		"poster_save_url": filePath + posterName,
	})
}
```

è¿™å—æ¶‰åŠåˆ°å¤§é‡çŸ¥è¯†ï¼Œå¼ºçƒˆå»ºè®®é˜…è¯»ä¸‹ï¼Œå¦‚ä¸‹ï¼š

- [image.Rect](https://golang.org/pkg/image/#Rect)
- [image.Pt](https://golang.org/pkg/image/#Pt)
- [image.NewRGBA](https://golang.org/pkg/image/#NewRGBA)
- [jpeg.Encode](https://golang.org/pkg/image/jpeg/#Encode)
- [jpeg.Decode](https://golang.org/pkg/image/jpeg/#Decode)
- [draw.Op](https://golang.org/pkg/image/draw/#Op)
- [draw.Draw](https://golang.org/pkg/image/draw/#Draw)
- [go-imagedraw-package](https://blog.golang.org/go-imagedraw-package)

å…¶æ‰€æ¶‰åŠã€å…³è”çš„åº“éƒ½å»ºè®®ç ”ç©¶ä¸€ä¸‹

### StaticFS

åœ¨ routers/router.go æ–‡ä»¶ï¼Œå¢åŠ å¦‚ä¸‹ä»£ç :

```go
r.StaticFS("/qrcode", http.Dir(qrcode.GetQrCodeFullPath()))
```

### éªŒè¯

![image](https://s2.ax1x.com/2020/02/15/1xMLCQ.jpg)

è®¿é—®å®Œæ•´çš„ URL è·¯å¾„ï¼Œè¿”å›åˆæˆåçš„æµ·æŠ¥å¹¶æ‰«é™¤äºŒç»´ç æˆåŠŸåˆ™æ­£ç¡® ğŸ¤“

![image](https://s2.ax1x.com/2020/02/15/1xMhjI.jpg)

## æ€»ç»“

åœ¨æœ¬ç« èŠ‚å®ç°äº†ä¸¤ä¸ªå¾ˆå¸¸è§çš„ä¸šåŠ¡åŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯ç”ŸæˆäºŒç»´ç å’Œåˆå¹¶æµ·æŠ¥ã€‚å¸Œæœ›ä½ èƒ½å¤Ÿä»”ç»†é˜…è¯»æˆ‘ç»™å‡ºçš„é“¾æ¥ï¼Œè¿™å—çš„çŸ¥è¯†é‡ä¸å°‘ï¼Œæƒ³è¦ç”¨å¥½å›¾åƒå¤„ç†çš„åŠŸèƒ½ï¼Œå¿…é¡»ç†è§£å¯¹åº”çš„æ€è·¯ï¼Œä¸¾ä¸€åä¸‰

æœ€åå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ‘Œ

## å‚è€ƒ

### æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç 

- [go-gin-example](https://github.com/EDDYCJY/go-gin-example)

## å…³äº

### ä¿®æ”¹è®°å½•

- ç¬¬ä¸€ç‰ˆï¼š2018 å¹´ 02 æœˆ 16 æ—¥å‘å¸ƒæ–‡ç« 
- ç¬¬äºŒç‰ˆï¼š2019 å¹´ 10 æœˆ 02 æ—¥ä¿®æ”¹æ–‡ç« 

## ï¼Ÿ

å¦‚æœæœ‰ä»»ä½•ç–‘é—®æˆ–é”™è¯¯ï¼Œæ¬¢è¿åœ¨ [issues](https://github.com/EDDYCJY/blog) è¿›è¡Œæé—®æˆ–ç»™äºˆä¿®æ­£æ„è§ï¼Œå¦‚æœå–œæ¬¢æˆ–å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿ Starï¼Œå¯¹ä½œè€…æ˜¯ä¸€ç§é¼“åŠ±å’Œæ¨è¿›ã€‚

### æˆ‘çš„å…¬ä¼—å·

![image](https://image.eddycjy.com/8d0b0c3a11e74efd5fdfd7910257e70b.jpg)