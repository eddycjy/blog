---

title:      "ã€Œè¿è½½ä¸ƒã€è®©ä½ çš„æœåŠ¡åŒæ—¶æä¾› HTTP æ¥å£"
date:       2018-10-12 12:00:00
author:     "ç…é±¼"
toc: true
tags:
    - go
    - grpc
---

## å‰è¨€

- æ¥å£éœ€è¦æä¾›ç»™å…¶ä»–ä¸šåŠ¡ç»„è®¿é—®ï¼Œä½†æ˜¯ RPC åè®®ä¸åŒæ— æ³•å†…è°ƒï¼Œå¯¹æ–¹é—®èƒ½å¦èµ° HTTP æ¥å£ï¼Œæ€ä¹ˆåŠï¼Ÿ

- å¾®ä¿¡ï¼ˆå…¬ä¼—å·ã€å°ç¨‹åºï¼‰ç­‰ç¬¬ä¸‰æ–¹å›è°ƒæ¥å£åªæ”¯æŒ HTTP æ¥å£ï¼Œæ€ä¹ˆåŠ

æˆ‘ç›¸ä¿¡ä½ åœ¨å®é™…å·¥ä½œä¸­éƒ½ä¼šé‡åˆ°å¦‚ä¸Šé—®é¢˜ï¼Œåœ¨ gRPC ä¸­éƒ½æ˜¯æœ‰è§£å†³æ–¹æ¡ˆçš„ï¼Œæœ¬ç« èŠ‚å°†ä¼šè¿›è¡Œä»‹ç» ğŸ¤” 

## ä¸ºä»€ä¹ˆå¯ä»¥åŒæ—¶æä¾› HTTP æ¥å£

å…³é”®ä¸€ç‚¹ï¼ŒgRPC çš„åè®®æ˜¯åŸºäº HTTP/2 çš„ï¼Œå› æ­¤åº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨å•ä¸ª TCP ç«¯å£ä¸Šæä¾› HTTP/1.1 å’Œ gRPC æ¥å£æœåŠ¡ï¼ˆä¸¤ç§ä¸åŒçš„æµé‡ï¼‰

## æ€ä¹ˆåŒæ—¶æä¾› HTTP æ¥å£

### æ£€æµ‹åè®®

```
if r.ProtoMajor == 2 && strings.Contains(r.Header.Get("Content-Type"), "application/grpc") {
    server.ServeHTTP(w, r)
} else {
    mux.ServeHTTP(w, r)
}
```

### æµç¨‹

1. æ£€æµ‹è¯·æ±‚åè®®æ˜¯å¦ä¸º HTTP/2
2. åˆ¤æ–­ Content-Type æ˜¯å¦ä¸º application/grpcï¼ˆgRPC çš„é»˜è®¤æ ‡è¯†ä½ï¼‰
3. æ ¹æ®åè®®çš„ä¸åŒè½¬å‘åˆ°ä¸åŒçš„æœåŠ¡å¤„ç†

## gRPC

### TLS

åœ¨å‰é¢çš„ç« èŠ‚ï¼Œä¸ºäº†ä¾¿äºå±•ç¤ºå› æ­¤æ²¡æœ‰ç®€å•å°è£…

åœ¨æœ¬èŠ‚éœ€å¤ç”¨ä»£ç ï¼Œé‡æ–°å°è£…äº†ï¼Œå¯è¯¦è§ï¼š[go-grpc-example](https://github.com/EDDYCJY/go-grpc-example/tree/master/pkg/gtls)

### ç›®å½•ç»“æ„

æ–°å»º simple_http_clientã€simple_http_server ç›®å½•ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```
go-grpc-example
â”œâ”€â”€ client
â”‚Â Â  â”œâ”€â”€ simple_client
â”‚Â Â  â”œâ”€â”€ simple_http_client
â”‚Â Â  â””â”€â”€ stream_client
â”œâ”€â”€ conf
â”œâ”€â”€ pkg
â”‚Â Â  â””â”€â”€ gtls
â”œâ”€â”€ proto
â”œâ”€â”€ server
â”‚Â Â  â”œâ”€â”€ simple_http_server
â”‚Â Â  â”œâ”€â”€ simple_server
â”‚Â Â  â””â”€â”€ stream_server
```

### Server

åœ¨ simple_http_server ç›®å½•ä¸‹æ–°å»º server.goï¼Œå†™å…¥æ–‡ä»¶å†…å®¹ï¼š

```
package main

import (
	"context"
	"log"
	"net/http"
	"strings"

	"github.com/EDDYCJY/go-grpc-example/pkg/gtls"
	pb "github.com/EDDYCJY/go-grpc-example/proto"

	"google.golang.org/grpc"
)

type SearchService struct{}

func (s *SearchService) Search(ctx context.Context, r *pb.SearchRequest) (*pb.SearchResponse, error) {
	return &pb.SearchResponse{Response: r.GetRequest() + " HTTP Server"}, nil
}

const PORT = "9003"

func main() {
	certFile := "../../conf/server/server.pem"
	keyFile := "../../conf/server/server.key"
	tlsServer := gtls.Server{
		CertFile: certFile,
		KeyFile:  keyFile,
	}

	c, err := tlsServer.GetTLSCredentials()
	if err != nil {
		log.Fatalf("tlsServer.GetTLSCredentials err: %v", err)
	}

	mux := GetHTTPServeMux()

	server := grpc.NewServer(grpc.Creds(c))
	pb.RegisterSearchServiceServer(server, &SearchService{})

	http.ListenAndServeTLS(":"+PORT,
		certFile,
		keyFile,
		http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			if r.ProtoMajor == 2 && strings.Contains(r.Header.Get("Content-Type"), "application/grpc") {
				server.ServeHTTP(w, r)
			} else {
				mux.ServeHTTP(w, r)
			}

			return
		}),
	)
}

func GetHTTPServeMux() *http.ServeMux {
	mux := http.NewServeMux()
	mux.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		w.Write([]byte("eddycjy: go-grpc-example"))
	})

	return mux
}
```

- http.NewServeMuxï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ ServeMuxï¼ŒServeMux æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè·¯ç”±è¡¨ã€‚å®ƒé»˜è®¤å®ç°äº† ServeHTTPï¼Œå› æ­¤è¿”å› Handler åå¯ç›´æ¥é€šè¿‡ HandleFunc æ³¨å†Œ pattern å’Œå¤„ç†é€»è¾‘çš„æ–¹æ³•
- http.ListenAndServeTLSï¼šå¯ç®€å•çš„ç†è§£ä¸ºæä¾›ç›‘å¬ HTTPS æœåŠ¡çš„æ–¹æ³•ï¼Œé‡ç‚¹çš„åè®®åˆ¤æ–­è½¬å‘ï¼Œä¹Ÿåœ¨è¿™é‡Œé¢

å…¶å®ï¼Œä½ ç†è§£åå°±ä¼šè§‰å¾—å¾ˆç®€å•ï¼Œæ ¸å¿ƒæ­¥éª¤ï¼šåˆ¤æ–­ -> è½¬å‘ -> å“åº”ã€‚æˆ‘ä»¬æ”¹å˜äº†å‰ä¸¤æ­¥çš„é»˜è®¤é€»è¾‘ï¼Œä»…æ­¤è€Œå·²

### Client

åœ¨ simple_http_server ç›®å½•ä¸‹æ–°å»º client.goï¼Œå†™å…¥æ–‡ä»¶å†…å®¹ï¼š

```
package main

import (
	"context"
	"log"

	"google.golang.org/grpc"

	"github.com/EDDYCJY/go-grpc-example/pkg/gtls"
	pb "github.com/EDDYCJY/go-grpc-example/proto"
)

const PORT = "9003"

func main() {
	tlsClient := gtls.Client{
		ServerName: "go-grpc-example",
		CertFile:   "../../conf/server/server.pem",
	}
	c, err := tlsClient.GetTLSCredentials()
	if err != nil {
		log.Fatalf("tlsClient.GetTLSCredentials err: %v", err)
	}

	conn, err := grpc.Dial(":"+PORT, grpc.WithTransportCredentials(c))
	if err != nil {
		log.Fatalf("grpc.Dial err: %v", err)
	}
	defer conn.Close()

	client := pb.NewSearchServiceClient(conn)
	resp, err := client.Search(context.Background(), &pb.SearchRequest{
		Request: "gRPC",
	})
	if err != nil {
		log.Fatalf("client.Search err: %v", err)
	}

	log.Printf("resp: %s", resp.GetResponse())
}
```

## éªŒè¯

### gRPC Client

```
$ go run client.go 
2018/10/04 14:56:56 resp: gRPC HTTP Server
```

### HTTP/1.1 è®¿é—®

![image](https://image.eddycjy.com/1d92cb9e949e32eef7f8a64a6a77deb9.jpg)

## æ€»ç»“

é€šè¿‡æœ¬ç« èŠ‚ï¼Œè¡¨é¢ä¸Šå®Œæˆäº†åŒç«¯å£æä¾›åŒæœåŠ¡çš„åŠŸèƒ½ï¼Œä½†å®é™…ä¸Šï¼Œåº”è¯¥æ˜¯åŠ æ·±äº† HTTP/2 çš„ç†è§£å’Œä½¿ç”¨ï¼Œè¿™æ‰æ˜¯æœ¬è´¨

## æ‹“å±•

å¦‚æœä½ æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œæ˜¯è¦**åŒæ—¶æä¾›** RPC å’Œ RESTful JSON API ä¸¤ç§æ¥å£çš„ï¼Œä¸è¦çŠ¹è±«ï¼Œç‚¹è¿›å»ï¼š[gRPC + gRPC Gateway å®è·µ](https://segmentfault.com/a/1190000013339403)

## é—®é¢˜

ä½ ä»¥ä¸ºè¿™ä¸ªæ–¹æ¡ˆå°±ä¸‡èƒ½äº†å—ï¼Œä¸ã€‚Envoy Proxy çš„æ”¯æŒå°±ä¸å®Œç¾ï¼Œæ— æ³•åŒæ—¶ç›‘å¬ä¸€ä¸ªç«¯å£çš„ä¸¤ç§æµé‡ ğŸ˜¤

## å‚è€ƒ

### æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç 

- [go-grpc-example](https://github.com/EDDYCJY/go-grpc-example)