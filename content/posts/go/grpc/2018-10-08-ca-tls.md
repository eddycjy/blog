---

title:      "ã€Œè¿è½½äº”ã€åŸºäº CA çš„ TLS è¯ä¹¦è®¤è¯"
date:       2018-10-08 12:00:00
author:     "ç…é±¼"
toc: true
tags:
    - go
    - grpc
---

## å‰è¨€

åœ¨ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªé—®é¢˜ã€‚å°±æ˜¯å¦‚ä½•ä¿è¯è¯ä¹¦çš„å¯é æ€§å’Œæœ‰æ•ˆæ€§ï¼Ÿä½ å¦‚ä½•ç¡®å®šä½  Serverã€Client çš„è¯ä¹¦æ˜¯å¯¹çš„å‘¢ï¼Ÿ

## CA

ä¸ºäº†ä¿è¯è¯ä¹¦çš„å¯é æ€§å’Œæœ‰æ•ˆæ€§ï¼Œåœ¨è¿™é‡Œå¯å¼•å…¥ CA é¢å‘çš„æ ¹è¯ä¹¦çš„æ¦‚å¿µã€‚å…¶éµå®ˆ X.509 æ ‡å‡†

### æ ¹è¯ä¹¦

æ ¹è¯ä¹¦ï¼ˆroot certificateï¼‰æ˜¯å±äºæ ¹è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰çš„å…¬é’¥è¯ä¹¦ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡éªŒè¯ CA çš„ç­¾åä»è€Œä¿¡ä»» CA ï¼Œä»»ä½•äººéƒ½å¯ä»¥å¾—åˆ° CA çš„è¯ä¹¦ï¼ˆå«å…¬é’¥ï¼‰ï¼Œç”¨ä»¥éªŒè¯å®ƒæ‰€ç­¾å‘çš„è¯ä¹¦ï¼ˆå®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ï¼‰


å®ƒåŒ…å«çš„æ–‡ä»¶å¦‚ä¸‹ï¼š

- å…¬é’¥
- å¯†é’¥

### ç”Ÿæˆ Key

```
openssl genrsa -out ca.key 2048
```

### ç”Ÿæˆå¯†é’¥

```
openssl req -new -x509 -days 7200 -key ca.key -out ca.pem
```

#### å¡«å†™ä¿¡æ¯

```
Country Name (2 letter code) []:
State or Province Name (full name) []:
Locality Name (eg, city) []:
Organization Name (eg, company) []:
Organizational Unit Name (eg, section) []:
Common Name (eg, fully qualified host name) []:go-grpc-example
Email Address []:
```

### Server

#### ç”Ÿæˆ CSR

```
openssl req -new -key server.key -out server.csr
```

##### å¡«å†™ä¿¡æ¯

```
Country Name (2 letter code) []:
State or Province Name (full name) []:
Locality Name (eg, city) []:
Organization Name (eg, company) []:
Organizational Unit Name (eg, section) []:
Common Name (eg, fully qualified host name) []:go-grpc-example
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
```

CSR æ˜¯ Cerificate Signing Request çš„è‹±æ–‡ç¼©å†™ï¼Œä¸ºè¯ä¹¦è¯·æ±‚æ–‡ä»¶ã€‚ä¸»è¦ä½œç”¨æ˜¯ CA ä¼šåˆ©ç”¨ CSR æ–‡ä»¶è¿›è¡Œç­¾åä½¿å¾—æ”»å‡»è€…æ— æ³•ä¼ªè£…æˆ–ç¯¡æ”¹åŸæœ‰è¯ä¹¦

#### åŸºäº CA ç­¾å‘

```
openssl x509 -req -sha256 -CA ca.pem -CAkey ca.key -CAcreateserial -days 3650 -in server.csr -out server.pem
```

### Client

### ç”Ÿæˆ Key

```
openssl ecparam -genkey -name secp384r1 -out client.key
```

### ç”Ÿæˆ CSR

```
openssl req -new -key client.key -out client.csr
```

#### åŸºäº CA ç­¾å‘

```
openssl x509 -req -sha256 -CA ca.pem -CAkey ca.key -CAcreateserial -days 3650 -in client.csr -out client.pem
```

### æ•´ç†ç›®å½•

è‡³æ­¤æˆ‘ä»¬ç”Ÿæˆäº†ä¸€å †æ–‡ä»¶ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹ç›®å½•ç»“æ„å­˜æ”¾ï¼š

```
$ tree conf 
conf
â”œâ”€â”€ ca.key
â”œâ”€â”€ ca.pem
â”œâ”€â”€ ca.srl
â”œâ”€â”€ client
â”‚Â Â  â”œâ”€â”€ client.csr
â”‚Â Â  â”œâ”€â”€ client.key
â”‚Â Â  â””â”€â”€ client.pem
â””â”€â”€ server
    â”œâ”€â”€ server.csr
    â”œâ”€â”€ server.key
    â””â”€â”€ server.pem
```

å¦å¤–æœ‰ä¸€äº›æ–‡ä»¶æ˜¯ä¸åº”è¯¥å‡ºç°åœ¨ä»“åº“å†…ï¼Œåº”å½“ä¿å¯†æˆ–åˆ é™¤çš„ã€‚ä½†ä¸ºäº†çœŸå®æ¼”ç¤ºæ‰€ä»¥ä¿ç•™ç€ï¼ˆæ•²é»‘æ¿ï¼‰

## gRPC

æ¥ä¸‹æ¥å°†æ­£å¼å¼€å§‹é’ˆå¯¹ gRPC è¿›è¡Œç¼–ç ï¼Œæ”¹é€ ä¸Šä¸€ç« èŠ‚çš„ä»£ç ã€‚ç›®æ ‡æ˜¯åŸºäº CA è¿›è¡Œ TLS è®¤è¯ ğŸ¤«

### Server

```
package main

import (
	"context"
	"log"
	"net"
	"crypto/tls"
	"crypto/x509"
	"io/ioutil"

	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials"

	pb "github.com/EDDYCJY/go-grpc-example/proto"
)

...

const PORT = "9001"

func main() {
	cert, err := tls.LoadX509KeyPair("../../conf/server/server.pem", "../../conf/server/server.key")
	if err != nil {
		log.Fatalf("tls.LoadX509KeyPair err: %v", err)
	}

	certPool := x509.NewCertPool()
	ca, err := ioutil.ReadFile("../../conf/ca.pem")
	if err != nil {
		log.Fatalf("ioutil.ReadFile err: %v", err)
	}

	if ok := certPool.AppendCertsFromPEM(ca); !ok {
		log.Fatalf("certPool.AppendCertsFromPEM err")
	}

	c := credentials.NewTLS(&tls.Config{
		Certificates: []tls.Certificate{cert},
		ClientAuth:   tls.RequireAndVerifyClientCert,
		ClientCAs:    certPool,
	})

	server := grpc.NewServer(grpc.Creds(c))
	pb.RegisterSearchServiceServer(server, &SearchService{})

	lis, err := net.Listen("tcp", ":"+PORT)
	if err != nil {
		log.Fatalf("net.Listen err: %v", err)
	}

	server.Serve(lis)
}
```

- tls.LoadX509KeyPair()ï¼šä»è¯ä¹¦ç›¸å…³æ–‡ä»¶ä¸­**è¯»å–**å’Œ**è§£æ**ä¿¡æ¯ï¼Œå¾—åˆ°è¯ä¹¦å…¬é’¥ã€å¯†é’¥å¯¹

```
func LoadX509KeyPair(certFile, keyFile string) (Certificate, error) {
	certPEMBlock, err := ioutil.ReadFile(certFile)
	if err != nil {
		return Certificate{}, err
	}
	keyPEMBlock, err := ioutil.ReadFile(keyFile)
	if err != nil {
		return Certificate{}, err
	}
	return X509KeyPair(certPEMBlock, keyPEMBlock)
}
```

- x509.NewCertPool()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç©ºçš„ CertPool
- certPool.AppendCertsFromPEM()ï¼šå°è¯•è§£ææ‰€ä¼ å…¥çš„ PEM ç¼–ç çš„è¯ä¹¦ã€‚å¦‚æœè§£ææˆåŠŸä¼šå°†å…¶åŠ åˆ° CertPool ä¸­ï¼Œä¾¿äºåé¢çš„ä½¿ç”¨
- credentials.NewTLSï¼šæ„å»ºåŸºäº TLS çš„ TransportCredentials é€‰é¡¹
- tls.Configï¼šConfig ç»“æ„ç”¨äºé…ç½® TLS å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨

åœ¨ Serverï¼Œå…±ä½¿ç”¨äº†ä¸‰ä¸ª Config é…ç½®é¡¹ï¼š

ï¼ˆ1ï¼‰Certificatesï¼šè®¾ç½®è¯ä¹¦é“¾ï¼Œå…è®¸åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª

ï¼ˆ2ï¼‰ClientAuthï¼šè¦æ±‚å¿…é¡»æ ¡éªŒå®¢æˆ·ç«¯çš„è¯ä¹¦ã€‚å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰ç”¨ä»¥ä¸‹å‚æ•°ï¼š

```
const (
	NoClientCert ClientAuthType = iota
	RequestClientCert
	RequireAnyClientCert
	VerifyClientCertIfGiven
	RequireAndVerifyClientCert
)
```

ï¼ˆ3ï¼‰ClientCAsï¼šè®¾ç½®æ ¹è¯ä¹¦çš„é›†åˆï¼Œæ ¡éªŒæ–¹å¼ä½¿ç”¨ ClientAuth ä¸­è®¾å®šçš„æ¨¡å¼

### Client

```
package main

import (
	"context"
	"crypto/tls"
	"crypto/x509"
	"io/ioutil"
	"log"

	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials"

	pb "github.com/EDDYCJY/go-grpc-example/proto"
)

const PORT = "9001"

func main() {
	cert, err := tls.LoadX509KeyPair("../../conf/client/client.pem", "../../conf/client/client.key")
	if err != nil {
		log.Fatalf("tls.LoadX509KeyPair err: %v", err)
	}

	certPool := x509.NewCertPool()
	ca, err := ioutil.ReadFile("../../conf/ca.pem")
	if err != nil {
		log.Fatalf("ioutil.ReadFile err: %v", err)
	}

	if ok := certPool.AppendCertsFromPEM(ca); !ok {
		log.Fatalf("certPool.AppendCertsFromPEM err")
	}

	c := credentials.NewTLS(&tls.Config{
		Certificates: []tls.Certificate{cert},
		ServerName:   "go-grpc-example",
		RootCAs:      certPool,
	})

	conn, err := grpc.Dial(":"+PORT, grpc.WithTransportCredentials(c))
	if err != nil {
		log.Fatalf("grpc.Dial err: %v", err)
	}
	defer conn.Close()

	client := pb.NewSearchServiceClient(conn)
	resp, err := client.Search(context.Background(), &pb.SearchRequest{
		Request: "gRPC",
	})
	if err != nil {
		log.Fatalf("client.Search err: %v", err)
	}

	log.Printf("resp: %s", resp.GetResponse())
}
```

åœ¨ Client ä¸­ç»å¤§éƒ¨åˆ†ä¸ Server ä¸€è‡´ï¼Œä¸åŒç‚¹çš„åœ°æ–¹æ˜¯ï¼Œåœ¨ Client è¯·æ±‚ Server ç«¯æ—¶ï¼ŒClient ç«¯ä¼šä½¿ç”¨æ ¹è¯ä¹¦å’Œ ServerName å»å¯¹ Server ç«¯è¿›è¡Œæ ¡éªŒ

ç®€å•æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

1. Client é€šè¿‡è¯·æ±‚å¾—åˆ° Server ç«¯çš„è¯ä¹¦
2. ä½¿ç”¨ CA è®¤è¯çš„æ ¹è¯ä¹¦å¯¹ Server ç«¯çš„è¯ä¹¦è¿›è¡Œå¯é æ€§ã€æœ‰æ•ˆæ€§ç­‰æ ¡éªŒ
3. æ ¡éªŒ ServerName æ˜¯å¦å¯ç”¨ã€æœ‰æ•ˆ

å½“ç„¶äº†ï¼Œåœ¨è®¾ç½®äº† `tls.RequireAndVerifyClientCert` æ¨¡å¼çš„æƒ…å†µä¸‹ï¼ŒServer ä¹Ÿä¼šä½¿ç”¨ CA è®¤è¯çš„æ ¹è¯ä¹¦å¯¹ Client ç«¯çš„è¯ä¹¦è¿›è¡Œå¯é æ€§ã€æœ‰æ•ˆæ€§ç­‰æ ¡éªŒã€‚ä¹Ÿå°±æ˜¯ä¸¤è¾¹éƒ½ä¼šè¿›è¡Œæ ¡éªŒï¼Œæå¤§çš„ä¿è¯äº†å®‰å…¨æ€§ ğŸ‘

### éªŒè¯

é‡æ–°å¯åŠ¨ server.go å’Œæ‰§è¡Œ client.goï¼ŒæŸ¥çœ‹å“åº”ç»“æœæ˜¯å¦æ­£å¸¸

## æ€»ç»“

åœ¨æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ CA é¢å‘çš„æ ¹è¯ä¹¦å¯¹å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯çš„è¯ä¹¦è¿›è¡Œäº†ç­¾å‘ã€‚è¿›ä¸€æ­¥çš„æé«˜äº†ä¸¤è€…çš„é€šè®¯å®‰å…¨ 

è¿™å›æ˜¯çœŸçš„å¤§åŠŸå‘Šæˆäº†ï¼

## å‚è€ƒ

### æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç 

- [go-grpc-example](https://github.com/EDDYCJY/go-grpc-example)