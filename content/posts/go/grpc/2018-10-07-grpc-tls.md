---

title:      "ã€Œè¿è½½å››ã€TLS è¯ä¹¦è®¤è¯"
date:       2018-10-07 12:00:00
author:     "ç…é±¼"
toc: true
tags:
    - go
    - grpc
---

## å‰è¨€

åœ¨å‰é¢çš„ç« èŠ‚é‡Œï¼Œæˆ‘ä»¬ä»‹ç»äº† gRPC çš„å››ç§ API ä½¿ç”¨æ–¹å¼ã€‚æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ ğŸ˜€

æ­¤æ—¶å­˜åœ¨ä¸€ä¸ªå®‰å…¨é—®é¢˜ï¼Œå…ˆå‰çš„ä¾‹å­ä¸­ gRPC Client/Server éƒ½æ˜¯æ˜æ–‡ä¼ è¾“çš„ï¼Œä¼šä¸ä¼šæœ‰è¢«çªƒå¬çš„é£é™©å‘¢ï¼Ÿ

ä»ç»“è®ºä¸Šæ¥è®²ï¼Œæ˜¯æœ‰çš„ã€‚åœ¨æ˜æ–‡é€šè®¯çš„æƒ…å†µä¸‹ï¼Œä½ çš„è¯·æ±‚å°±æ˜¯è£¸å¥”çš„ï¼Œæœ‰å¯èƒ½è¢«ç¬¬ä¸‰æ–¹æ¶æ„ç¯¡æ”¹æˆ–è€…ä¼ªé€ ä¸ºâ€œéæ³•â€çš„æ•°æ®

## æŠ“ä¸ªåŒ…

![image](https://image.eddycjy.com/15e68df2ba9aa7cace3e26e35c79f200.jpg)

![image](https://image.eddycjy.com/ebebd3ea7d306ad2fcd311f1d8b46cc0.jpg)

å—¯ï¼Œæ˜æ–‡ä¼ è¾“æ— è¯¯ã€‚è¿™æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¥ä¸‹å°†æ”¹é€ æˆ‘ä»¬çš„ gRPCï¼Œä»¥ä¾¿äºè§£å†³è¿™ä¸ªé—®é¢˜ ğŸ˜¤

## è¯ä¹¦ç”Ÿæˆ

### ç§é’¥

```
openssl ecparam -genkey -name secp384r1 -out server.key
```

### è‡ªç­¾å…¬é’¥

```
openssl req -new -x509 -sha256 -key server.key -out server.pem -days 3650
```

#### å¡«å†™ä¿¡æ¯

```
Country Name (2 letter code) []:
State or Province Name (full name) []:
Locality Name (eg, city) []:
Organization Name (eg, company) []:
Organizational Unit Name (eg, section) []:
Common Name (eg, fully qualified host name) []:go-grpc-example
Email Address []:
```

### ç”Ÿæˆå®Œæ¯•

ç”Ÿæˆè¯ä¹¦ç»“æŸåï¼Œå°†è¯ä¹¦ç›¸å…³æ–‡ä»¶æ”¾åˆ° conf/ ä¸‹ï¼Œç›®å½•ç»“æ„ï¼š

```
$ tree go-grpc-example
go-grpc-example
â”œâ”€â”€ client
â”œâ”€â”€ conf
â”‚Â Â  â”œâ”€â”€ server.key
â”‚Â Â  â””â”€â”€ server.pem
â”œâ”€â”€ proto
â””â”€â”€ server
    â”œâ”€â”€ simple_server
    â””â”€â”€ stream_server
```

ç”±äºæœ¬æ–‡åå‘ gRPCï¼Œè¯¦è§£å¯å‚è§ [ã€Šåˆ¶ä½œè¯ä¹¦ã€‹](https://segmentfault.com/a/1190000013408485#articleHeader3)ã€‚åç»­ç•ªå¤–å¯èƒ½ä¼šå±•å¼€ç»†èŠ‚æè¿° ğŸ‘Œ

## ä¸ºä»€ä¹ˆä¹‹å‰ä¸éœ€è¦è¯ä¹¦

åœ¨ simple_server ä¸­ï¼Œä¸ºä»€ä¹ˆâ€œå•¥äº‹éƒ½æ²¡å¹²â€å°±èƒ½åœ¨ä¸éœ€è¦è¯ä¹¦çš„æƒ…å†µä¸‹è¿è¡Œå‘¢ï¼Ÿ

### Server

```go
grpc.NewServer()
```

åœ¨æœåŠ¡ç«¯æ˜¾ç„¶æ²¡æœ‰ä¼ å…¥ä»»ä½• DialOptions

### Client

```go
conn, err := grpc.Dial(":"+PORT, grpc.WithInsecure())
```

åœ¨å®¢æˆ·ç«¯ç•™æ„åˆ° `grpc.WithInsecure()` æ–¹æ³•

```go
func WithInsecure() DialOption {
	return newFuncDialOption(func(o *dialOptions) {
		o.insecure = true
	})
}
```

åœ¨æ–¹æ³•å†…å¯ä»¥çœ‹åˆ° `WithInsecure` è¿”å›ä¸€ä¸ª `DialOption`ï¼Œå¹¶ä¸”å®ƒæœ€ç»ˆä¼šé€šè¿‡è¯»å–è®¾ç½®çš„å€¼æ¥ç¦ç”¨å®‰å…¨ä¼ è¾“

é‚£ä¹ˆå®ƒâ€œæœ€ç»ˆâ€åˆæ˜¯åœ¨å“ªé‡Œå¤„ç†çš„å‘¢ï¼Œæˆ‘ä»¬æŠŠè§†çº¿ç§»åˆ° `grpc.Dial()` æ–¹æ³•å†…

```go
func DialContext(ctx context.Context, target string, opts ...DialOption) (conn *ClientConn, err error) {
    ...

    for _, opt := range opts {
		opt.apply(&cc.dopts)
	}
    ...

    if !cc.dopts.insecure {
		if cc.dopts.copts.TransportCredentials == nil {
			return nil, errNoTransportSecurity
		}
	} else {
		if cc.dopts.copts.TransportCredentials != nil {
			return nil, errCredentialsConflict
		}
		for _, cd := range cc.dopts.copts.PerRPCCredentials {
			if cd.RequireTransportSecurity() {
				return nil, errTransportCredentialsMissing
			}
		}
	}
	...

	creds := cc.dopts.copts.TransportCredentials
	if creds != nil && creds.Info().ServerName != "" {
		cc.authority = creds.Info().ServerName
	} else if cc.dopts.insecure && cc.dopts.authority != "" {
		cc.authority = cc.dopts.authority
	} else {
		// Use endpoint from "scheme://authority/endpoint" as the default
		// authority for ClientConn.
		cc.authority = cc.parsedTarget.Endpoint
	}
	...
}
```

## gRPC

æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ­£å¼å¼€å§‹ç¼–ç ï¼Œåœ¨ gRPC Client/Server ä¸Šå®ç° TLS è¯ä¹¦è®¤è¯çš„æ”¯æŒ ğŸ¤”

### TLS Server

```go
package main

import (
	"context"
	"log"
	"net"

	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials"

	pb "github.com/EDDYCJY/go-grpc-example/proto"
)

...

const PORT = "9001"

func main() {
	c, err := credentials.NewServerTLSFromFile("../../conf/server.pem", "../../conf/server.key")
	if err != nil {
		log.Fatalf("credentials.NewServerTLSFromFile err: %v", err)
	}

	server := grpc.NewServer(grpc.Creds(c))
	pb.RegisterSearchServiceServer(server, &SearchService{})

	lis, err := net.Listen("tcp", ":"+PORT)
	if err != nil {
		log.Fatalf("net.Listen err: %v", err)
	}

	server.Serve(lis)
}
```

- credentials.NewServerTLSFromFileï¼šæ ¹æ®æœåŠ¡ç«¯è¾“å…¥çš„è¯ä¹¦æ–‡ä»¶å’Œå¯†é’¥æ„é€  TLS å‡­è¯

```go
func NewServerTLSFromFile(certFile, keyFile string) (TransportCredentials, error) {
	cert, err := tls.LoadX509KeyPair(certFile, keyFile)
	if err != nil {
		return nil, err
	}
	return NewTLS(&tls.Config{Certificates: []tls.Certificate{cert}}), nil
}
```

- grpc.Creds()ï¼šè¿”å›ä¸€ä¸ª ServerOptionï¼Œç”¨äºè®¾ç½®æœåŠ¡å™¨è¿æ¥çš„å‡­æ®ã€‚ç”¨äº `grpc.NewServer(opt ...ServerOption)` ä¸º gRPC Server è®¾ç½®è¿æ¥é€‰é¡¹

```go
func Creds(c credentials.TransportCredentials) ServerOption {
	return func(o *options) {
		o.creds = c
	}
}
```

ç»è¿‡ä»¥ä¸Šä¸¤ä¸ªç®€å•æ­¥éª¤ï¼ŒgRPC Server å°±å»ºç«‹èµ·éœ€è¯ä¹¦è®¤è¯çš„æœåŠ¡å•¦ ğŸ¤”

### TLS Client

```go
package main

import (
	"context"
	"log"

	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials"

	pb "github.com/EDDYCJY/go-grpc-example/proto"
)

const PORT = "9001"

func main() {
	c, err := credentials.NewClientTLSFromFile("../../conf/server.pem", "go-grpc-example")
	if err != nil {
		log.Fatalf("credentials.NewClientTLSFromFile err: %v", err)
	}

	conn, err := grpc.Dial(":"+PORT, grpc.WithTransportCredentials(c))
	if err != nil {
		log.Fatalf("grpc.Dial err: %v", err)
	}
	defer conn.Close()

	client := pb.NewSearchServiceClient(conn)
	resp, err := client.Search(context.Background(), &pb.SearchRequest{
		Request: "gRPC",
	})
	if err != nil {
		log.Fatalf("client.Search err: %v", err)
	}

	log.Printf("resp: %s", resp.GetResponse())
}
```

- credentials.NewClientTLSFromFile()ï¼šæ ¹æ®å®¢æˆ·ç«¯è¾“å…¥çš„è¯ä¹¦æ–‡ä»¶å’Œå¯†é’¥æ„é€  TLS å‡­è¯ã€‚serverNameOverride ä¸ºæœåŠ¡åç§°

```go
func NewClientTLSFromFile(certFile, serverNameOverride string) (TransportCredentials, error) {
	b, err := ioutil.ReadFile(certFile)
	if err != nil {
		return nil, err
	}
	cp := x509.NewCertPool()
	if !cp.AppendCertsFromPEM(b) {
		return nil, fmt.Errorf("credentials: failed to append certificates")
	}
	return NewTLS(&tls.Config{ServerName: serverNameOverride, RootCAs: cp}), nil
}
```

- grpc.WithTransportCredentials()ï¼šè¿”å›ä¸€ä¸ªé…ç½®è¿æ¥çš„ DialOption é€‰é¡¹ã€‚ç”¨äº `grpc.Dial(target string, opts ...DialOption)` è®¾ç½®è¿æ¥é€‰é¡¹

```go
func WithTransportCredentials(creds credentials.TransportCredentials) DialOption {
	return newFuncDialOption(func(o *dialOptions) {
		o.copts.TransportCredentials = creds
	})
}
```

## éªŒè¯

### è¯·æ±‚

é‡æ–°å¯åŠ¨ server.go å’Œæ‰§è¡Œ client.goï¼Œå¾—åˆ°å“åº”ç»“æœ

```
$ go run client.go
2018/09/30 20:00:21 resp: gRPC Server
```

### æŠ“ä¸ªåŒ…

![image](https://image.eddycjy.com/c8ad6edf1f7d084883b847b3eee29dd2.jpg)

æˆåŠŸã€‚

## æ€»ç»“

åœ¨æœ¬ç« èŠ‚æˆ‘ä»¬å®ç°äº† gRPC TLS Client/Servertï¼Œä½ ä»¥ä¸ºå¤§åŠŸå‘Šæˆäº†å—ï¼Ÿæˆ‘ä¸ ğŸ˜¤

## é—®é¢˜

ä½ ä»”ç»†å†çœ‹çœ‹ï¼ŒClient æ˜¯åŸºäº Server ç«¯çš„è¯ä¹¦å’ŒæœåŠ¡åç§°æ¥å»ºç«‹è¯·æ±‚çš„ã€‚è¿™æ ·çš„è¯ï¼Œä½ å°±éœ€è¦å°† Server çš„è¯ä¹¦é€šè¿‡å„ç§æ‰‹æ®µç»™åˆ° Client ç«¯ï¼Œå¦åˆ™æ˜¯æ— æ³•å®Œæˆè¿™é¡¹ä»»åŠ¡çš„

é—®é¢˜ä¹Ÿå°±æ¥äº†ï¼Œä½ æ— æ³•ä¿è¯ä½ çš„â€œå„ç§æ‰‹æ®µâ€æ˜¯å®‰å…¨çš„ï¼Œæ¯•ç«Ÿç°åœ¨çš„ç½‘ç»œç¯å¢ƒæ˜¯å¾ˆå±é™©çš„ï¼Œä¸‡ä¸€è¢«...

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« èŠ‚è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¿è¯å…¶å¯é æ€§ ğŸ™‚

## å‚è€ƒ

### æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç 

- [go-grpc-example](https://github.com/EDDYCJY/go-grpc-example)