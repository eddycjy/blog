---

title:      "log æ ‡å‡†åº“"
date:       2018-09-28 12:00:00
author:     "ç…é±¼"
toc: true
tags:
    - go
    - æºç åˆ†æ
---

## æ—¥å¿—

### è¾“å‡º

```
2018/09/28 20:03:08 EDDYCJY Blog...
```

### æ„æˆ

[æ—¥æœŸ]<ç©ºæ ¼>[æ—¶åˆ†ç§’]<ç©ºæ ¼>[å†…å®¹]<\n>

## æºç å‰–æ

### Logger

```
type Logger struct {
	mu     sync.Mutex 
	prefix string
	flag   int
	out    io.Writer
	buf    []byte
}
```

1. muï¼šäº’æ–¥é”ï¼Œç”¨äºç¡®ä¿åŸå­çš„å†™å…¥
2. prefixï¼šæ¯è¡Œéœ€å†™å…¥çš„æ—¥å¿—å‰ç¼€å†…å®¹
3. flagï¼šè®¾ç½®æ—¥å¿—è¾…åŠ©ä¿¡æ¯ï¼ˆæ—¶é—´ã€æ–‡ä»¶åã€è¡Œå·ï¼‰çš„å†™å…¥ã€‚å¯é€‰å¦‚ä¸‹æ ‡è¯†ä½ï¼š

```
const (
	Ldate         = 1 << iota       // value: 1
	Ltime                           // value: 2
	Lmicroseconds                   // value: 4
	Llongfile                       // value: 8
	Lshortfile                      // value: 16
	LUTC                            // value: 32
	LstdFlags     = Ldate | Ltime   // value: 3
)
```

- Ldateï¼šå½“åœ°æ—¶åŒºçš„æ ¼å¼åŒ–æ—¥æœŸï¼š2009/01/23
- Ltimeï¼šå½“åœ°æ—¶åŒºçš„æ ¼å¼åŒ–æ—¶é—´ï¼š01:23:23
- Lmicrosecondsï¼šåœ¨ Ltime çš„åŸºç¡€ä¸Šï¼Œå¢åŠ å¾®ç§’çš„æ—¶é—´æ•°å€¼æ˜¾ç¤º
- Llongfileï¼šå®Œæ•´çš„æ–‡ä»¶åå’Œè¡Œå·ï¼š/a/b/c/d.go:23
- Lshortfileï¼šå½“å‰æ–‡ä»¶åå’Œè¡Œå·ï¼šd.goï¼š23ï¼Œä¼šè¦†ç›– Llongfile æ ‡è¯†
- LUTCï¼šå¦‚æœè®¾ç½® Ldate æˆ– Ltimeï¼Œä¸”è®¾ç½® LUTCï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ UTC æ—¶åŒºè€Œä¸æ˜¯æœ¬åœ°æ—¶åŒº
- LstdFlagsï¼šLogger çš„é»˜è®¤åˆå§‹å€¼ï¼ˆLdate å’Œ Ltimeï¼‰

4. outï¼šio.Writer
5. bufï¼šç”¨äºå­˜å‚¨å°†è¦å†™å…¥çš„æ—¥å¿—å†…å®¹

### New

```
func New(out io.Writer, prefix string, flag int) *Logger {
	return &Logger{out: out, prefix: prefix, flag: flag}
}

var std = New(os.Stderr, "", LstdFlags)
```

New æ–¹æ³•ç”¨äºåˆå§‹åŒ– Loggerï¼Œæ¥å—ä¸‰ä¸ªåˆå§‹å‚æ•°ï¼Œå¯ä»¥å®šåˆ¶åŒ–è€Œåœ¨ log åŒ…å†…é»˜è®¤ä¼šåˆå§‹ä¸€ä¸ª stdï¼Œå®ƒæŒ‡å‘æ ‡å‡†è¾“å…¥æµã€‚è€Œé»˜è®¤çš„æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯å°±æ˜¯æ˜¾ç¤ºå™¨ï¼ˆè¾“å‡ºåˆ°å±å¹•ä¸Šï¼‰ï¼Œæ ‡å‡†è¾“å…¥å°±æ˜¯é”®ç›˜ã€‚è¾…åŠ©çš„æ—¶é—´ä¿¡æ¯é»˜è®¤ä¸º `Ldate | Ltime`ï¼Œä¹Ÿå°±æ˜¯ `2009/01/23 01:23:23`

```
// os
var (
	Stdin  = NewFile(uintptr(syscall.Stdin), "/dev/stdin")
	Stdout = NewFile(uintptr(syscall.Stdout), "/dev/stdout")
	Stderr = NewFile(uintptr(syscall.Stderr), "/dev/stderr")
)
```

- Stdinï¼šæ ‡å‡†è¾“å…¥
- Stdoutï¼šæ ‡å‡†è¾“å‡º
- Stderrï¼šæ ‡å‡†é”™è¯¯

### Getter

- Flags
- Prefix

### Setter

- SetFlags
- SetPrefix
- SetOutput

### Print*, Fatal*, Panic*

```
func Print(v ...interface{}) {
	std.Output(2, fmt.Sprint(v...))
}

func Printf(format string, v ...interface{}) {
	std.Output(2, fmt.Sprintf(format, v...))
}

func Println(v ...interface{}) {
	std.Output(2, fmt.Sprintln(v...))
}

func Fatal(v ...interface{}) {
	std.Output(2, fmt.Sprint(v...))
	os.Exit(1)
}

func Panic(v ...interface{}) {
	s := fmt.Sprint(v...)
	std.Output(2, s)
	panic(s)
}

...
```

è¿™ä¸€éƒ¨åˆ†ä»‹ç»æœ€å¸¸ç”¨çš„æ—¥å¿—å†™å…¥æ–¹æ³•ï¼Œä»æºç å¯å¾—çŸ¥ `Xrintln`ã€`Xrintf` å‡½æ•° **æ¢è¡Œ**ã€**å¯å˜å‚æ•°**éƒ½æ˜¯é€šè¿‡ `fmt` æ ‡å‡†åº“çš„æ–¹æ³•å»å®ç°çš„

`Fatal` å’Œ `Panic` æ˜¯é€šè¿‡ `os.Exit(1)`ã€`panic(s)` é›†æˆå®ç°çš„ã€‚è€Œå…·ä½“çš„ç»„è£…é€»è¾‘æ˜¯é€šè¿‡ `Output` æ–¹æ³•å®ç°çš„

#### Logger.Output

```
func (l *Logger) Output(calldepth int, s string) error {
	now := time.Now() // get this early.
	var file string
	var line int
	l.mu.Lock()
	defer l.mu.Unlock()
	if l.flag&(Lshortfile|Llongfile) != 0 {
		// Release lock while getting caller info - it's expensive.
		l.mu.Unlock()
		var ok bool
		_, file, line, ok = runtime.Caller(calldepth)
		if !ok {
			file = "???"
			line = 0
		}
		l.mu.Lock()
	}
	l.buf = l.buf[:0]
	l.formatHeader(&l.buf, now, file, line)
	l.buf = append(l.buf, s...)
	if len(s) == 0 || s[len(s)-1] != '\n' {
		l.buf = append(l.buf, '\n')
	}
	_, err := l.out.Write(l.buf)
	return err
}
```

Output æ–¹æ³•ï¼Œç®€å•æ¥è®²å°±æ˜¯å°†å†™å…¥çš„æ—¥å¿—äº‹ä»¶ä¿¡æ¯ç»„è£…å¹¶è¾“å‡ºï¼Œå®ƒä¼šæ ¹æ® flag æ ‡è¯†ä½çš„ä¸åŒæ¥ä½¿ç”¨ `runtime.Caller` å»è·å–å½“å‰ goroutine æ‰€æ‰§è¡Œçš„å‡½æ•°æ–‡ä»¶ã€è¡Œå·ç­‰è°ƒç”¨ä¿¡æ¯ï¼ˆlog æ ‡å‡†åº“ä¸­é»˜è®¤æ·±åº¦ä¸º 2ï¼‰ã€‚å¦å¤–å¦‚æœç»“å°¾ä¸æ˜¯æ¢è¡Œç¬¦ `\n`ï¼Œå°†è‡ªåŠ¨è¡¥å…¨ä¸€ä¸ªæ¢è¡Œ

#### Logger.formatHeader

```
func (l *Logger) formatHeader(buf *[]byte, t time.Time, file string, line int) {
	*buf = append(*buf, l.prefix...)
	if l.flag&(Ldate|Ltime|Lmicroseconds) != 0 {
		if l.flag&LUTC != 0 {
			t = t.UTC()
		}
		if l.flag&Ldate != 0 {
			year, month, day := t.Date()
			itoa(buf, year, 4)
			*buf = append(*buf, '/')
			itoa(buf, int(month), 2)
			*buf = append(*buf, '/')
			itoa(buf, day, 2)
			*buf = append(*buf, ' ')
		}
		if l.flag&(Ltime|Lmicroseconds) != 0 {
			hour, min, sec := t.Clock()
			itoa(buf, hour, 2)
			*buf = append(*buf, ':')
			itoa(buf, min, 2)
			*buf = append(*buf, ':')
			itoa(buf, sec, 2)
			if l.flag&Lmicroseconds != 0 {
				*buf = append(*buf, '.')
				itoa(buf, t.Nanosecond()/1e3, 6)
			}
			*buf = append(*buf, ' ')
		}
	}
	if l.flag&(Lshortfile|Llongfile) != 0 {
		if l.flag&Lshortfile != 0 {
			short := file
			for i := len(file) - 1; i > 0; i-- {
				if file[i] == '/' {
					short = file[i+1:]
					break
				}
			}
			file = short
		}
		*buf = append(*buf, file...)
		*buf = append(*buf, ':')
		itoa(buf, line, -1)
		*buf = append(*buf, ": "...)
	}
}
```

è¯¥æ–¹æ³•ä¸»è¦æ˜¯ç”¨äºæ ¼å¼åŒ–æ—¥å¿—å¤´ï¼ˆå‰ç¼€ï¼‰ï¼Œæ ¹æ®å…¥å‚ä¸åŒçš„æ ‡è¯†ä½ï¼Œæ·»åŠ åˆ†éš”ç¬¦å’Œå¯¹åº”çš„å€¼åˆ°æ—¥å¿—ä¿¡æ¯ä¸­ã€‚æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

ï¼ˆ1ï¼‰å¦‚æœä¸æ˜¯ç©ºå€¼ï¼Œåˆ™å°† prefix å†™å…¥ buf

ï¼ˆ2ï¼‰å¦‚æœè®¾ç½® `Ldate`ã€`Ltime`ã€`Lmicroseconds`ï¼Œåˆ™å¯¹åº”å°†æ—¥æœŸå’Œæ—¶é—´å†™å…¥ buf

ï¼ˆ3ï¼‰å¦‚æœè®¾ç½® `Lshortfile`ã€`Llongfile`ï¼Œåˆ™å¯¹åº”å°†æ–‡ä»¶å’Œè¡Œå·ä¿¡æ¯å†™å…¥ buf

#### Logger.itoa

```
func itoa(buf *[]byte, i int, wid int) {
	// Assemble decimal in reverse order.
	var b [20]byte
	bp := len(b) - 1
	for i >= 10 || wid > 1 {
		wid--
		q := i / 10
		b[bp] = byte('0' + i - q*10)
		bp--
		i = q
	}
	// i < 10
	b[bp] = byte('0' + i)
	*buf = append(*buf, b[bp:]...)
}
```

è¯¥æ–¹æ³•ä¸»è¦ç”¨äºå°†æ•´æ•°è½¬æ¢ä¸ºå®šé•¿çš„åè¿›åˆ¶ ASCIIï¼ŒåŒæ—¶ç»™å‡ºè´Ÿæ•°å®½åº¦é¿å…å·¦ä¾§è¡¥ 0ã€‚å¦å¤–ä¼šä»¥ç›¸åçš„é¡ºåºç»„åˆåè¿›åˆ¶ 

### å¦‚ä½•å®šåˆ¶åŒ– Logger

åœ¨æ ‡å‡†åº“å†…ï¼Œå¯é€šè¿‡å…¶å¼€æ”¾çš„ New æ–¹æ³•æ¥å®ç°å„ç§å„æ ·çš„è‡ªå®šä¹‰ Logger ç»„ä»¶ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¹Ÿå¯ä»¥ç›´æ¥ `log.Print*` ç­‰æ–¹æ³•å‘¢ï¼Ÿ

```
func New(out io.Writer, prefix string, flag int) *Logger
```

å…¶å®æ˜¯åœ¨æ ‡å‡†åº“å†…ï¼Œå¦‚æœä½ åˆšåˆšç»†å¿ƒçš„çœ‹äº†å‰é¢çš„å°èŠ‚ï¼Œä¸éš¾å‘ç°å…¶é»˜è®¤å®ç°äº†ä¸€ä¸ª Logger ç»„ä»¶

```
var std = New(os.Stderr, "", LstdFlags)
```

è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå°å°çš„ç²¾å¦™ä¹‹å¤„ â­•ï¸

## æ€»ç»“

é€šè¿‡æŸ¥é˜… log æ ‡å‡†åº“çš„æºç ï¼Œå¯å¾—çŸ¥æœ€ç®€å•çš„ä¸€ä¸ªæ—¥å¿—åŒ…åº”è¯¥å¦‚ä½•ç¼–å†™ã€‚å¦å¤– log åŒ…æ˜¯åœ¨æ‰€æœ‰æ¶‰åŠåˆ° Logger çš„åœ°æ–¹éƒ½å¯¹ `sync.Mutex` è¿›è¡Œæ“ä½œï¼ˆä»¥æ­¤è§£å†³åŸå­é—®é¢˜ï¼‰ï¼Œå…¶ä½™é€»è¾‘å‡ä¸ºç»„è£…æ—¥å¿—ä¿¡æ¯å’Œè½¬æ¢æ•°å€¼æ ¼å¼ï¼Œè¯¥åŒ…è¾ƒä¸ºç»å…¸ï¼Œå¯ä»¥å¤šè¯»å‡ é ğŸ˜„

## é—®é¢˜

ä¸ºä»€ä¹ˆåœ¨è°ƒç”¨ `runtime.Caller` å‰è¦å…ˆè§£é”ï¼Œåå†åŠ é”å‘¢?
